<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculadora e Registro de Vendas Hells Angels</title>
  <style>
    :root {
      --cor-fundo: #fff0f6;
      --cor-texto: #4a0033;
      --cor-principal: #e60073;
      --cor-card: #ffffff;
      --cor-borda: #ffb3d9;
      --cor-btn-primario: #e60073;
      --cor-btn-texto: #fff;
      --cor-btn-secundario: #ffd6eb;
      --cor-btn-secundario-texto: #4a0033;
    }

    body.dark {
      --cor-fundo: #1a000d; 
      --cor-texto: #ffccf0; 
      --cor-principal: #ff0080; 
      --cor-card: #2c001a; 
      --cor-borda: #e60073; 
      --cor-btn-primario: #ff0080; 
      --cor-btn-texto: #fff;
      --cor-btn-secundario: #4d002a; 
      --cor-btn-secundario-texto: #ffccf0; 
    }
    
    body.dark input[type=number], body.dark input[type=text], body.dark select {
      background: #33001f;
      color: var(--cor-texto);
      border: 1px solid var(--cor-borda);
    }
    
    /* --- ESTILOS TOUR (SEM SETA) --- */
    .tour-tooltip {
      position: absolute;
      background: var(--cor-principal);
      color: var(--cor-btn-texto);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      max-width: 300px;
      text-align: left;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 10002;
    }

    .tour-tooltip.active {
      opacity: 1;
      transform: translateY(0);
    }

    .tour-tooltip h4 {
        margin: 0 0 5px;
        font-size: 16px;
        color: var(--cor-btn-texto);
    }
    .tour-tooltip p {
        margin: 0;
        font-size: 14px;
        margin-bottom: 10px;
    }
    
    .tour-tooltip button {
        background: var(--cor-btn-secundario);
        color: var(--cor-btn-secundario-texto);
        padding: 6px 10px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        margin-right: 8px;
    }
    
    .tour-highlight {
      box-shadow: 0 0 0 3px rgba(230,0,115,0.6), 0 0 10px rgba(230,0,115,0.5);
      position: relative;
      z-index: 10001;
    }
    /* --- FIM ESTILOS TOUR --- */

    
    .app-logo {
      position: fixed;
      top: 16px; 
      left: 16px; 
      max-height: 80px; 
      width: auto;
      z-index: 9998; 
      transition: opacity 0.3s ease; 
    }
    
    #welcomeScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--cor-card);
      z-index: 10000; 
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      transition: opacity 0.5s ease;
      padding: 20px;
    }
    
    #welcomeScreen.hidden {
      opacity: 0;
      pointer-events: none; 
    }
    
    #welcomeScreen h2 {
      font-size: 36px;
      margin-bottom: 20px;
      color: var(--cor-principal);
    }
    
    #welcomeScreen button {
      padding: 12px 24px;
      font-size: 18px;
      border-radius: 10px;
      margin-top: 10px;
    }


    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 960px;
      margin: 24px auto;
      padding: 20px;
      background: var(--cor-fundo);
      border-radius: 12px;
      color: var(--cor-texto);
      transition: background 0.25s ease, color 0.25s ease;
    }

    h1 {
      margin: 0 0 12px;
      font-size: 24px;
      font-weight: 700;
      color: var(--cor-principal);
      text-align: center;
    }

    h2 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--cor-principal);
    }
    
    h3 {
        color: var(--cor-principal); 
        font-weight:600; 
        margin-top: 16px;
    }

    .card {
      background: var(--cor-card);
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 1px solid var(--cor-borda);
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin: 10px 0 6px;
      font-weight: 600;
      color: var(--cor-principal);
    }

    input[type=number], input[type=text], select {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid var(--cor-borda);
      background: #fff;
      color: var(--cor-texto);
      font-size: 14px;
      box-sizing: border-box;
    }
    
    input[type=number] {
        width: 140px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      margin-top: 12px;
    }
    
    .grid-venda {
        grid-template-columns: 1fr 1fr;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 14px;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid var(--cor-borda);
      text-align: left;
    }

    th {
      background: var(--cor-btn-secundario);
      color: var(--cor-btn-secundario-texto);
      font-weight: 600;
    }

    .actions {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    button {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: opacity 0.2s ease;
    }

    button:hover { opacity: 0.85; }

    .primary { background: var(--cor-btn-primario); color: var(--cor-btn-texto); }
    .muted { background: var(--cor-btn-secundario); color: var(--cor-btn-secundario-texto); }
    .success { background: #00b33c; color: #fff; }
    /* Estilos para os novos bot√µes de a√ß√£o */
    .warning { background: #ff9900; color: #fff; } /* Edit (Laranja) */
    .danger { background: #e60000; color: #fff; } /* Excluir (Vermelho) }
    /* FIM Estilos para os novos bot√µes de a√ß√£o */

    /* NOVO: Container para agrupar e posicionar bot√µes (Modo Noturno e Tutorial) */
    .top-right-controls {
        position: fixed;
        top: 16px;
        right: 16px;
        display: flex;
        gap: 10px;
        z-index: 9999;
    }

    /* NOVO: Estilo base para bot√µes de controle fixos */
    .control-btn {
        padding: 10px 14px;
        border-radius: 10px;
        background: var(--cor-btn-primario);
        color: var(--cor-btn-texto);
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        border: none;
        transition: opacity 0.2s ease;
    }
    .control-btn:hover {
        opacity: 0.85;
    }
    
    #historyCard table {
        font-size: 12px;
    }
    #historyCard th, #historyCard td {
        padding: 6px;
        vertical-align: top;
    }
    
    /* NOVO: Estilos para a estrutura do hist√≥rico (lado a lado e empilhada) */
    .history-action-group {
        display: flex;
        flex-direction: column; /* Empilha data e a linha de bot√µes */
        gap: 6px; /* Espa√ßo entre a data e a linha de bot√µes */
    }
    .history-discord-cell {
        display: flex;
        flex-direction: row; /* Coloca os bot√µes lado a lado */
        gap: 4px; /* Espa√ßamento entre os bot√µes */
        flex-wrap: wrap; /* Garante que quebre a linha se a tela for pequena */
    }
    .history-discord-cell button {
        padding: 4px 8px;
        font-size: 11px;
        margin-top: 0; 
    }
    /* FIM NOVO: Estilos para a estrutura do hist√≥rico */
  </style>
</head>
<body class="light">
  
  <img id="appLogo" src="logotipo-light.png" alt="Hells Angels Logo" class="app-logo">

  <div id="welcomeScreen" class="card">
      <h2 style="font-weight: 900;">Bem-vindo(a)</h2>
      <p style="margin-bottom: 20px; font-size: 16px;">Calculadora e Registro de Vendas Hells Angels</p>
      <button id="enterBtn" class="primary">Entrar no Site</button>
  </div>
  
  <div class="top-right-controls">
      <button class="control-btn" id="tutorialBtn">üí° Tutorial</button> 
      <button class="control-btn" id="themeBtn">üåô Modo Noturno</button>
  </div>
  <div class="card" id="mainCard">
    <h1>Calculadora e Registro de Vendas Hells Angels</h1>
    
    <div class="card-venda">
        <h2>Dados da Venda</h2>
        <div class="grid grid-venda">
            <div>
                <label for="nomeCliente">Nome:</label>
                <input id="nomeCliente" type="text" value="">
            </div>
            <div>
                <label for="dataVenda">Data:</label>
                <input id="dataVenda" type="text" readonly>
            </div>
            
            <div>
                <label for="organizacao">Organiza√ß√£o:</label>
                <input id="organizacao" type="text" value="">
            </div>
            <div>
                <label for="organizacaoTipo">Op√ß√£o (CNPJ/CPF):</label>
                <select id="organizacaoTipo">
                    <option value="CNPJ">CNPJ</option>
                    <option value="CPF">CPF</option>
                    <option value="OUTROS">Outros</option>
                </select>
            </div>
            
            <div>
                <label for="telefone">Telefone:</label>
                <input id="telefone" type="text" value="" maxlength="13"> 
            </div>
            
            <div>
                <label for="negociadoras">Negociadoras:</label>
                <input id="negociadoras" type="text" value="">
            </div>
            <div style="grid-column: 1 / -1;">
                <label for="vendaValorObs">Valor - Observa√ß√£o (Como foi o pagamento):</label>
                <input id="vendaValorObs" type="text" value="">
            </div>
        </div>
    </div>
    
    <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--cor-borda);">

    <h2>C√°lculo de Produtos</h2>
    <p class="small">Informe quantos produtos deseja fabricar/vender e escolha o tipo de valor.</p>

    <div class="grid">
      <div>
        <label for="qtyTickets">Quantidade de Tickets</label>
        <input id="qtyTickets" type="number" min="0" value="">
      </div>
      <div>
        <label for="qtyTablets">Quantidade de Tablets</label>
        <input id="qtyTablets" type="number" min="0" value="">
      </div>
      <div>
        <label for="qtyNitro">Quantidade de Nitro</label>
        <input id="qtyNitro" type="number" min="0" value="">
      </div>
      <div>
        <label for="tipoValor">Tipo de Valor</label>
        <select id="tipoValor">
          <option value="limpo">Dinheiro Limpo</option>
          <option value="sujo">Dinheiro Sujo</option>
          <option value="limpo_alianca">Limpo (Alian√ßa)</option>
          <option value="sujo_alianca">Sujo (Alian√ßa)</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <button id="calcBtn" class="primary">Calcular</button>
      <button id="resetBtn" class="muted">Limpar Campos</button>
      <button id="registerBtn" class="success">Registrar Venda</button>
      <button id="toggleHistoryBtn" class="muted">Ver Hist√≥rico</button>
      <button id="csvBtn" class="muted">Exportar CSV</button>
      <button id="discordBtn" class="muted">Copiar para Discord</button>
    </div>

    <div id="resultsContainer">
      <div id="results" style="margin-top:16px;display:none">
        <h3>Totais necess√°rios</h3>
        <table>
          <thead><tr><th>Material</th><th>Quantidade total</th></tr></thead>
          <tbody id="resultsBody"></tbody>
        </table>

        <h3>Valores Estimados</h3>
        <table>
          <thead><tr><th>Produto</th><th>Valor Total</th></tr></thead>
          <tbody id="valuesBody"></tbody>
          <tfoot>
            <tr><th>Total Geral</th><th id="valorTotalGeral">R$ 0</th></tr>
          </tfoot>
        </table>
        <p class="result-note" style="font-size: 12px; margin-top: 8px;">Os valores variam conforme o tipo selecionado (limpo, sujo, alian√ßa).</p>
      </div>
    </div>
  </div>

  <div class="card" id="historyCard" style="display:none">
    <h2>Hist√≥rico de Vendas Registradas</h2>
    <div class="actions">
      <button id="clearHistoryBtn" class="muted">Limpar Hist√≥rico</button>
      <button id="toggleCalcBtn" class="muted">Voltar √† Calculadora</button>
    </div>
    <table>
      <thead>
          <tr>
              <th>Data/A√ß√µes</th>
              <th>Cliente</th>
              <th>Organiza√ß√£o/Tipo</th>
              <th>Telefone</th>
              <th>Produtos (Unidade)</th>
              <th>Valor Total</th>
              <th>Negociadoras</th>
          </tr>
      </thead>
      <tbody id="salesHistory"></tbody>
    </table>
  </div>
  
  <script>
    const perUnit = {
      tickets: { moneyBruto: 525 },
      tablets: { cobre: 20, plastico: 40, fita_adesiva: 2, lixo_eletronico: 2 },
      nitro: { aluminio: 20, cobre: 20, vidro: 45, fita_adesiva: 1, porca: 1, parafuso: 1 }
    };

    const valores = {
      tablets: { limpo: 17000, sujo: 20000, limpo_alianca: 15000, sujo_alianca: 18000 },
      tickets: { limpo: 9800, sujo: 11700, limpo_alianca: 8000, sujo_alianca: 10000 },
      nitro: { limpo: 42500, sujo: 50000, limpo_alianca: 38000, sujo_alianca: 45000 }
    };
    
    const valorDescricao = {
        'limpo': 'Dinheiro Limpo',
        'sujo': 'Dinheiro Sujo',
        'limpo_alianca': 'Limpo (Alian√ßa)',
        'sujo_alianca': 'Sujo (Alian√ßa)'
    };
    
    // VARI√ÅVEL GLOBAL CHAVE PARA A EDI√á√ÉO
    let editingRow = null; 

    const els = {
      // Campos do C√°lculo
      qtyTickets: document.getElementById('qtyTickets'),
      qtyTablets: document.getElementById('qtyTablets'),
      qtyNitro: document.getElementById('qtyNitro'),
      tipoValor: document.getElementById('tipoValor'),
      
      // Campos do Cliente/Venda
      nomeCliente: document.getElementById('nomeCliente'),
      dataVenda: document.getElementById('dataVenda'),
      organizacaoTipo: document.getElementById('organizacaoTipo'),
      organizacao: document.getElementById('organizacao'),
      telefone: document.getElementById('telefone'),
      negociadoras: document.getElementById('negociadoras'),
      vendaValorObs: document.getElementById('vendaValorObs'),
      
      // Bot√µes
      calcBtn: document.getElementById('calcBtn'),
      resetBtn: document.getElementById('resetBtn'),
      csvBtn: document.getElementById('csvBtn'),
      registerBtn: document.getElementById('registerBtn'), 
      discordBtn: document.getElementById('discordBtn'), 
      
      // Resultados e Hist√≥rico
      results: document.getElementById('results'),
      resultsBody: document.getElementById('resultsBody'),
      valuesBody: document.getElementById('valuesBody'),
      valorTotalGeral: document.getElementById('valorTotalGeral'),
      salesHistory: document.getElementById('salesHistory'),
      clearHistoryBtn: document.getElementById('clearHistoryBtn'),
      
      // Bot√µes de controle fixos
      themeBtn: document.getElementById('themeBtn'),
      tutorialBtn: document.getElementById('tutorialBtn'),
      
      mainCard: document.getElementById('mainCard'), 
      historyCard: document.getElementById('historyCard'), 
      toggleHistoryBtn: document.getElementById('toggleHistoryBtn'), 
      toggleCalcBtn: document.getElementById('toggleCalcBtn'),
      
      // Elementos da tela de boas-vindas
      welcomeScreen: document.getElementById('welcomeScreen'),
      enterBtn: document.getElementById('enterBtn'),
      
      // Adicionado elemento da Logo
      appLogo: document.getElementById('appLogo'), 
    };

    // --- VARI√ÅVEIS DO TOUR (MANTIDAS) ---
    let currentTourStep = 0; 
    const tourSteps = [
        { target: els.nomeCliente, title: 'Passo 1: Nome do Cliente (1/17)', text: 'Comece digitando o nome do comprador. Pressione **Enter** para avan√ßar.' },
        { target: els.organizacao, title: 'Passo 2: Organiza√ß√£o (2/17)', text: 'Informe a Organiza√ß√£o/Empresa do cliente. Pressione **Enter** para avan√ßar.' },
        { target: els.organizacaoTipo, title: 'Passo 3: Tipo de Documento (3/17)', text: 'Selecione o tipo de identifica√ß√£o do cliente (CNPJ/CPF).' },
        { target: els.telefone, title: 'Passo 4: Telefone (4/17)', text: 'Digite o telefone do cliente. Ser√° formatado automaticamente.' },
        { target: els.negociadoras, title: 'Passo 5: Negociadoras (5/17)', text: 'Se houver mais de uma, separe por v√≠rgula. Ex: Ana, Bruna, Carla.' },
        { target: els.vendaValorObs, title: 'Passo 6: Observa√ß√£o (6/17)', text: 'Detalhe como foi o pagamento (Pix, Transfer√™ncia, etc.).' },
        { target: els.qtyTickets, title: 'Passo 7: Quantidade (7/17)', text: 'Informe a quantidade de **Tickets** que deseja vender/fabricar.' },
        { target: els.qtyTablets, title: 'Passo 8: Quantidade (8/17)', text: 'Informe a quantidade de **Tablets**.' },
        { target: els.qtyNitro, title: 'Passo 9: Quantidade (9/17)', text: 'Informe a quantidade de **Nitros**.' },
        { target: els.tipoValor, title: 'Passo 10: Tipo de Valor (10/17)', text: 'Escolha se o valor da venda √© Limpo, Sujo ou se √© uma venda para Alian√ßa.' },
        { target: els.calcBtn, title: 'Passo 11: Calcular (11/17)', text: 'Clique em **Calcular** para ver os materiais necess√°rios e o valor total estimado. Isso n√£o registra a venda.' },
        { target: els.registerBtn, title: 'Passo 12: Registrar Venda (12/17)', text: 'Este bot√£o salva a venda no hist√≥rico e deve ser usado ap√≥s o c√°lculo.' },
        { target: els.toggleHistoryBtn, title: 'Passo 13: Ver Hist√≥rico (13/17)', text: 'Veja todas as vendas registradas. Ao clicar, o site muda para a tela de hist√≥rico.' },
        { target: els.discordBtn, title: 'Passo 14: Copiar para Discord (14/17)', text: 'Copia os dados da venda atual para a √°rea de transfer√™ncia no formato ideal para postar no Discord.' },
        { target: els.csvBtn, title: 'Passo 15: Exportar CSV (15/17)', text: 'Exporta os materiais e valores calculados para um arquivo CSV (planilha).' },
        { target: els.resetBtn, title: 'Passo 16: Limpar Campos (16/17)', text: 'Apaga todos os dados inseridos e os resultados. √ötil para come√ßar uma nova venda.' },
        { target: document.getElementById('themeBtn'), title: 'Passo 17: Modo Noturno (17/17)', text: 'Finalizamos! Este bot√£o permite alternar entre os temas Claro e Noturno.' }
    ];
    // --- FIM VARI√ÅVEIS DO TOUR ---
    
    
    const logoLightModeSrc = "logotipo-light.png"; 
    const logoDarkModeSrc = "logotipo-escuro.png"; 
    
    // --- FUN√á√ïES DE FORMATO (MANTIDAS) ---
    function formatNome(key){return key.replace(/_/g,' ').replace(/(^|\s)\S/g,s=>s.toUpperCase());}
    function numberWithCommas(x){return (Number(x)||0).toLocaleString('pt-BR');}

    function capitalizeWords(event) {
        let input = event.target;
        let value = input.value;
        if (!value) return;

        const start = input.selectionStart;
        const end = input.selectionEnd;
        
        let formattedValue = value.toLowerCase().replace(/(^|\s)\S/g, (match) => {
            return match.toUpperCase();
        });

        input.value = formattedValue;
        input.setSelectionRange(start, end);
    }
    
    function formatarTelefone(event) {
        let input = event.target;
        let value = input.value.replace(/\D/g, ""); 
        
        let formattedValue = '';

        if (value.length > 0) {
            formattedValue += '(' + value.substring(0, 3);
        }
        if (value.length > 3) {
            formattedValue += ') ' + value.substring(3, 6);
        }
        if (value.length > 6) {
            formattedValue += '-' + value.substring(6, 9);
        }

        input.value = formattedValue;
    }

    function initDate() {
        const now = new Date();
        const day = String(now.getDate()).padStart(2, '0');
        const month = String(now.getMonth() + 1).padStart(2, '0');
        els.dataVenda.value = `${day}/${month}`;
    }
    initDate();
    
    function toggleView(showHistory) {
        if (showHistory) {
            els.mainCard.style.display = 'none';
            els.historyCard.style.display = 'block';
        } else {
            els.mainCard.style.display = 'block';
            els.historyCard.style.display = 'none';
             // Garante que o estado de edi√ß√£o seja resetado ao voltar para a calculadora
            resetSaleFormState(); 
        }
        
        clearTour();
    }
    
    // --- FUN√á√ïES DO TUTORIAL/TOUR (MANTIDAS) ---
    
    function clearTour() {
        currentTourStep = 0; 
        const existingTooltip = document.querySelector('.tour-tooltip');
        if (existingTooltip) {
            existingTooltip.remove();
        }
        document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
    }

    function updateTooltip(target, title, text, stepIndex) {
        clearTour();

        const rect = target.getBoundingClientRect();
        const tooltip = document.createElement('div');
        tooltip.className = 'tour-tooltip active';
        
        const totalSteps = tourSteps.length;
        const buttonText = stepIndex < totalSteps - 1 ? 'Pr√≥ximo (Enter)' : 'Finalizar';

        tooltip.innerHTML = `
            <h4>${title}</h4>
            <p>${text}</p>
            <button id="tourCloseBtn">Fechar</button>
            <button id="tourNextBtn" class="primary" style="float:right;">${buttonText}</button>
        `;
        
        document.body.appendChild(tooltip); 
        
        tooltip.querySelector('#tourCloseBtn').addEventListener('click', clearTour);
        tooltip.querySelector('#tourNextBtn').addEventListener('click', () => {
            if (stepIndex < totalSteps - 1) {
                nextStep();
            } else {
                clearTour();
            }
        });

        const tooltipWidth = tooltip.offsetWidth;
        const tooltipHeight = tooltip.offsetHeight;
        const targetCenterX = rect.left + rect.width / 2;
        let tooltipLeft = targetCenterX - tooltipWidth / 2;
        
        if (tooltipLeft < 10) tooltipLeft = 10;
        if (tooltipLeft + tooltipWidth > window.innerWidth - 10) {
            tooltipLeft = window.innerWidth - tooltipWidth - 10;
        }

        let tooltipTop = rect.top - tooltipHeight - 15;
        
        if (tooltipTop < 10) {
            tooltipTop = rect.bottom + 15;
        }

        tooltip.style.left = `${tooltipLeft}px`;
        tooltip.style.top = `${tooltipTop + window.scrollY}px`;

        target.classList.add('tour-highlight');
        currentTourStep = stepIndex + 1;
        
        if (target.tagName === 'INPUT' || target.tagName === 'SELECT') {
            target.focus();
        } else {
            tooltip.querySelector('#tourNextBtn').focus();
        }
    }
    
    function startTour(stepIndex) {
        clearAllFields(false); 
        
        els.welcomeScreen.classList.add('hidden');
        
        setTimeout(() => {
            els.welcomeScreen.style.display = 'none';
            els.mainCard.style.display = 'block';
            if (stepIndex < tourSteps.length) {
                const step = tourSteps[stepIndex];
                updateTooltip(step.target, step.title, step.text, stepIndex);
            }
        }, 500); 
    }
    
    function nextStep() {
        if (currentTourStep > 0 && currentTourStep < tourSteps.length) {
            const nextIndex = currentTourStep;
            const step = tourSteps[nextIndex];
            updateTooltip(step.target, step.title, step.text, nextIndex);
        } else if (currentTourStep === tourSteps.length) {
            clearTour(); 
        }
    }
    
    // --- FIM FUN√á√ïES DO TUTORIAL/TOUR ---

    function calculateTotals() {
      const qTickets = Math.max(0, Math.floor(Number(els.qtyTickets.value) || 0));
      const qTablets = Math.max(0, Math.floor(Number(els.qtyTablets.value) || 0));
      const qNitro = Math.max(0, Math.floor(Number(els.qtyNitro.value) || 0));
      const tipo = els.tipoValor.value;

      const totals = {};
      totals['Dinheiro Sujo (R$)'] = qTickets * perUnit.tickets.moneyBruto; 

      for (const [mat, qtd] of Object.entries(perUnit.tablets)) {
        totals[formatNome(mat)] = (totals[formatNome(mat)] || 0) + qtd * qTablets;
      }
      for (const [mat, qtd] of Object.entries(perUnit.nitro)) {
        totals[formatNome(mat)] = (totals[formatNome(mat)] || 0) + qtd * qNitro;
      }

      const valoresTotais = {};
      valoresTotais['Tickets'] = (valores.tickets?.[tipo] || 0) * qTickets;
      valoresTotais['Tablets'] = (valores.tablets?.[tipo] || 0) * qTablets;
      valoresTotais['Nitro'] = (valores.nitro?.[tipo] || 0) * qNitro;

      const valorTotalGeral = Object.values(valoresTotais).reduce((a,b)=>a+b,0);

      return { totals, valoresTotais, valorTotalGeral, qTickets, qTablets, qNitro, tipo };
    }

    function renderResults(data) {
      const { totals, valoresTotais, valorTotalGeral } = data;
      els.resultsBody.innerHTML = '';
      els.valuesBody.innerHTML = '';

      const keys = Object.keys(totals);
      keys.sort((a,b)=> (a.startsWith('D') ? -1 : a.localeCompare(b))); 

      for (const k of keys) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${k}</td><td>${numberWithCommas(totals[k])}</td>`;
        els.resultsBody.appendChild(tr);
      }

      for (const [produto, valor] of Object.entries(valoresTotais)) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${produto}</td><td>R$ ${numberWithCommas(valor)}</td>`;
        els.valuesBody.appendChild(tr);
      }

      els.valorTotalGeral.textContent = `R$ ${numberWithCommas(valorTotalGeral)}`;
      els.results.style.display = 'block';
    }
    
    // Fun√ß√£o para reverter o estado do formul√°rio de edi√ß√£o para registro
    function resetSaleFormState() {
        editingRow = null;
        // Ajusta os bot√µes da calculadora para o estado de "Registrar"
        els.registerBtn.textContent = 'Registrar Venda';
        els.registerBtn.classList.add('success');
        els.registerBtn.classList.remove('primary');
        // Mostra novamente os bot√µes escondidos no modo edi√ß√£o
        els.calcBtn.style.display = 'inline-block';
        els.discordBtn.style.display = 'inline-block';
        els.csvBtn.style.display = 'inline-block';
    }
    
    // Limpar TODOS os campos, o tour (opcionalmente) E resetar o estado de edi√ß√£o
    function clearAllFields(clearTourFlag = true) {
        els.qtyTickets.value = '';
        els.qtyTablets.value = '';
        els.qtyNitro.value = '';
        els.tipoValor.value = 'limpo';
        
        els.nomeCliente.value = '';
        els.organizacaoTipo.value = 'CNPJ';
        els.organizacao.value = '';
        els.telefone.value = '';
        els.negociadoras.value = '';
        els.vendaValorObs.value = '';
        
        els.results.style.display='none';
        initDate();
        
        if (clearTourFlag) {
            clearTour();
        }
        resetSaleFormState(); 
    }
    
    // Fun√ß√£o utilit√°ria para gerar o HTML da linha com os bot√µes
    function generateSaleRowHtml(saleData, valorComObs) {
        const { dataHora, cliente, organizacao, telefone, produtos, negociadoras } = saleData;
        
        return `
            <td>
                <div class="history-action-group">
                    <span>${dataHora}</span>
                    <div class="history-discord-cell">
                        <button class="muted discord-btn">Discord</button>
                        <button class="warning edit-btn">Editar</button>
                        <button class="danger delete-btn">Excluir</button>
                    </div>
                </div>
            </td>
            <td>${cliente}</td>
            <td>${organizacao}</td> 
            <td>${telefone}</td>
            <td>${produtos}</td>
            <td>${valorComObs}</td>
            <td>${negociadoras}</td>
        `;
    }
    
    // Fun√ß√£o para adicionar listeners aos bot√µes
    function addSaleRowListeners(tr) {
        tr.querySelector('.discord-btn').addEventListener('click', () => copyDiscordFromHistory(tr));
        
        tr.querySelector('.edit-btn').addEventListener('click', () => {
             loadSaleForEdit(tr);
        });
        
        tr.querySelector('.delete-btn').addEventListener('click', () => {
            if(confirm(`Tem certeza que deseja excluir a venda de ${tr.saleData.cliente}?`)) {
                 tr.remove(); 
                 // Se a linha exclu√≠da for a que estava em edi√ß√£o, resetamos o formul√°rio.
                 if (tr === editingRow) {
                     clearAllFields(false);
                 }
            }
        });
    }

    // Fun√ß√£o para carregar a venda para edi√ß√£o
    function loadSaleForEdit(tr) {
        const data = tr.saleData;
        
        // 1. Preenche o formul√°rio
        els.nomeCliente.value = data.cliente;
        // Ajuste para lidar com o formato 'TIPO - ORG'
        const [tipoOrg, orgName] = data.organizacao.split(' - '); 
        els.organizacaoTipo.value = tipoOrg || 'OUTROS';
        els.organizacao.value = orgName || data.organizacao;
        els.telefone.value = data.telefone;
        els.negociadoras.value = data.negociadoras;
        
        // Tenta preencher a observa√ß√£o (usa o valor salvo em data.valorObs)
        els.vendaValorObs.value = data.valorObs || ''; 
        
        // Preenche os campos de c√°lculo (Dados salvos no TR)
        els.qtyTickets.value = data.qTickets;
        els.qtyTablets.value = data.qTablets;
        els.qtyNitro.value = data.qNitro;
        els.tipoValor.value = data.tipoValor;


        // 2. Atualiza estado e bot√µes
        editingRow = tr; // <<-- CHAVE PARA SABER QUAL LINHA SER√Å EXCLU√çDA
        toggleView(false); // Volta para a tela da calculadora
        
        // Muda o bot√£o principal da calculadora para Salvar Edi√ß√£o
        els.registerBtn.textContent = 'Salvar Edi√ß√£o';
        els.registerBtn.classList.remove('success');
        els.registerBtn.classList.add('primary');
        // Esconde bot√µes irrelevantes para a edi√ß√£o
        els.calcBtn.style.display = 'none';
        els.discordBtn.style.display = 'none';
        els.csvBtn.style.display = 'none';

        alert(`Venda de ${data.cliente} carregada para edi√ß√£o. O bot√£o "Registrar Venda" agora √© "Salvar Edi√ß√£o".`);
    }

    // FUN√á√ÉO CHAVE PARA FINALIZAR A EDI√á√ÉO
    function updateSale(dataToSave) {
        if (!editingRow) {
            alert("Erro: Tentativa de atualizar venda sem linha de edi√ß√£o selecionada.");
            return;
        }
        
        const oldRow = editingRow;
        
        // PASSO 1: REMOVE A LINHA ANTIGA IMEDIATAMENTE (CORRE√á√ÉO FINAL ROBUSTA)
        if (oldRow.parentNode) {
            // Usa removeChild no parent (tbody) para garantir a remo√ß√£o
            oldRow.parentNode.removeChild(oldRow); 
        } else {
            // Fallback para o m√©todo mais simples
            oldRow.remove(); 
        }

        // PASSO 2: Cria o novo saleData completo (Mantendo a data/hora original)
        const newSaleData = {
            dataHora: oldRow.saleData.dataHora, 
            cliente: dataToSave.nome,
            organizacao: `${dataToSave.tipoOrg} - ${dataToSave.org}`,
            telefone: dataToSave.tel,
            produtos: dataToSave.produtosStr,
            valor: dataToSave.valorTotalGeral,
            valorObs: dataToSave.valorObs,
            negociadoras: dataToSave.negociadoras,
            qTickets: dataToSave.qTickets,
            qTablets: dataToSave.qTablets,
            qNitro: dataToSave.qNitro,
            tipoValor: dataToSave.tipo
        };
        
        // PASSO 3: Cria a nova linha.
        createSaleRow(newSaleData);
        
        // 4. Limpa o estado de edi√ß√£o e reseta os bot√µes da calculadora
        resetSaleFormState();
        
        alert(`Venda de ${dataToSave.nome} atualizada com sucesso no Hist√≥rico.`);
    }

    // Fun√ß√£o para criar uma NOVA linha de venda (Registro ou Edi√ß√£o)
    function createSaleRow(newSaleData) {
        const valorComObs = newSaleData.valorObs ? 
            `R$ ${numberWithCommas(newSaleData.valor)}<br><small>(${newSaleData.valorObs})</small>` :
            `R$ ${numberWithCommas(newSaleData.valor)}`;
            
        const tr = document.createElement('tr');
        tr.innerHTML = generateSaleRowHtml(newSaleData, valorComObs);
        
        // Armazena todos os dados necess√°rios no elemento TR
        tr.saleData = {
            dataHora: newSaleData.dataHora,
            cliente: newSaleData.cliente,
            organizacao: newSaleData.organizacao,
            telefone: newSaleData.telefone,
            produtos: newSaleData.produtos,
            valor: newSaleData.valor,
            valorObs: newSaleData.valorObs,
            negociadoras: newSaleData.negociadoras,
            qTickets: newSaleData.qTickets,
            qTablets: newSaleData.qTablets,
            qNitro: newSaleData.qNitro,
            tipoValor: newSaleData.tipoValor
        };
        
        addSaleRowListeners(tr);
        els.salesHistory.prepend(tr);
        
        return tr; 
    }

    // Fun√ß√£o principal de submiss√£o (Registro ou Edi√ß√£o)
    function handleSaleSubmission() {
        const calculatedData = calculateTotals();
        const { valorTotalGeral, qTickets, qTablets, qNitro, tipo } = calculatedData;
        
        if (valorTotalGeral <= 0 && qTickets === 0 && qTablets === 0 && qNitro === 0) {
            alert("O valor total da venda deve ser maior que R$ 0 ou ter produtos para registrar.");
            return;
        }
        
        // Extrai e formata os dados do formul√°rio
        const nome = els.nomeCliente.value.trim() || 'N/A';
        const tipoOrg = els.organizacaoTipo.value; 
        const org = els.organizacao.value.trim() || 'N/A';
        const tel = els.telefone.value.trim() || 'N/A'; 
        const negociadoras = els.negociadoras.value.trim() || 'N/A';
        let valorObs = els.vendaValorObs.value.trim();
        
        let descTipo = '';
        if (tipo === 'sujo' || tipo === 'sujo_alianca') {
            descTipo = valorDescricao[tipo] || '';
        }
        
        // Formata a observa√ß√£o para incluir o tipo de valor se for 'sujo'
        if (descTipo && !valorObs.toLowerCase().includes(descTipo.toLowerCase())) {
            valorObs = valorObs ? `${descTipo} | ${valorObs}` : descTipo;
        }
        
        const produtos = [];
        if(qTablets>0) produtos.push(`Tablet (${qTablets})`);
        if(qNitro>0) produtos.push(`Nitros (${qNitro})`);
        if(qTickets>0) produtos.push(`Tickets (${qTickets})`);
        const produtosStr = produtos.length > 0 ? produtos.join(', ') : 'Nenhum Produto';
        
        // Combina todos os dados da venda, incluindo os novos dados de c√°lculo
        const dataToSave = {
            ...calculatedData, 
            nome, tipoOrg, org, tel, negociadoras, valorObs, produtosStr
        };

        if (editingRow) {
            // SE ESTIVER EM MODO DE EDI√á√ÉO -> CHAMA A FUN√á√ÉO QUE REMOVE/CRIA
            updateSale(dataToSave);
        } else {
            // SE FOR UM NOVO REGISTRO
            const now = new Date();
            const hora = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const dataVenda = els.dataVenda.value; 
            
            const newSaleData = {
                dataHora: `${dataVenda} ${hora}`,
                cliente: nome,
                organizacao: `${tipoOrg} - ${org}`,
                telefone: tel,
                produtos: produtosStr,
                valor: valorTotalGeral,
                valorObs: valorObs, // A observa√ß√£o j√° est√° formatada
                negociadoras: negociadoras,
                // Salva as quantidades e tipo de valor para futura edi√ß√£o
                qTickets: qTickets,
                qTablets: qTablets,
                qNitro: qNitro,
                tipoValor: tipo
            };

            createSaleRow(newSaleData);
            alert(`Venda registrada com sucesso para ${nome} no valor de R$ ${numberWithCommas(valorTotalGeral)}.`);
            clearAllFields(false); 
        }
    }

    function copyDiscordFromHistory(tr) {
        const data = tr.saleData;
        
        const valorBase = `R$ ${numberWithCommas(data.valor)}`;
        // A observa√ß√£o salva em saleData j√° cont√©m o tipo de valor (ex: Dinheiro Sujo | Pix)
        const valorTotalFormatado = data.valorObs ? `${valorBase} (${data.valorObs})` : valorBase;

        const discordOutput = `
\`\`\`
Nome: ${data.cliente}
Data: ${data.dataHora}
Organiza√ß√£o: ${data.organizacao}
Telefone: ${data.telefone}
Produto (Unidade): ${data.produtos}
Venda Valor: ${valorTotalFormatado}
Negociadoras: ${data.negociadoras}
\`\`\`
`.trim();

        navigator.clipboard.writeText(discordOutput).then(() => {
            alert("Informa√ß√µes da venda copiadas para a √°rea de transfer√™ncia no formato Discord!");
        }).catch(err => {
            console.error('Erro ao copiar: ', err);
            alert("Erro ao copiar. Seu navegador pode n√£o suportar a c√≥pia autom√°tica.");
        });
    }
    
    function generateDiscordFormat() {
        const data = calculateTotals();
        const { valorTotalGeral, qTickets, qTablets, qNitro, tipo } = data;
        
        if (valorTotalGeral <= 0 && qTickets === 0 && qTablets === 0 && qNitro === 0) {
             alert("Por favor, informe a quantidade de produtos ou o tipo de valor antes de copiar.");
             return;
        }

        const nome = els.nomeCliente.value.trim() || 'N/A';
        const tipoOrg = els.organizacaoTipo.value; 
        const org = els.organizacao.value.trim() || 'N/A';
        const tel = els.telefone.value.trim() || 'N/A';
        const negociadoras = els.negociadoras.value.trim() || 'N/A';
        let valorObs = els.vendaValorObs.value.trim(); 
        
        let descTipo = '';
        if (tipo === 'sujo' || tipo === 'sujo_alianca') {
            descTipo = valorDescricao[tipo] || '';
        }
        
        // Formata a observa√ß√£o para incluir o tipo de valor se for 'sujo'
        if (descTipo && !valorObs.toLowerCase().includes(descTipo.toLowerCase())) {
            valorObs = valorObs ? `${descTipo} | ${valorObs}` : descTipo;
        }
        
        const dataVenda = els.dataVenda.value;
        
        const produtos = [];
        if(qTablets>0) produtos.push(`Tablet (${qTablets})`);
        if(qNitro>0) produtos.push(`Nitros (${qNitro})`);
        if(qTickets>0) produtos.push(`Tickets (${qTickets})`);
        
        const produtosStr = produtos.length > 0 ? produtos.join(', ') : 'Nenhum Produto';
        
        const valorBase = `R$ ${numberWithCommas(valorTotalGeral)}`;
        const valorTotalFormatado = valorObs ? `${valorBase} (${valorObs})` : valorBase;
        
        const discordOutput = `
\`\`\`
Nome: ${nome}
Data: ${dataVenda}
Organiza√ß√£o: ${tipoOrg} - ${org}
Telefone: ${tel}
Produto (Unidade): ${produtosStr}
Venda Valor: ${valorTotalFormatado}
Negociadoras: ${negociadoras}
\`\`\`
`.trim(); 

        navigator.clipboard.writeText(discordOutput).then(() => {
            alert("Informa√ß√µes da venda copiadas para a √°rea de transfer√™ncia no formato Discord!");
        }).catch(err => {
            console.error('Erro ao copiar: ', err);
            alert("Erro ao copiar. Seu navegador pode n√£o suportar a c√≥pia autom√°tica.");
        });
    }


    // --- L√≥gica de Enter para Avan√ßar (MANTIDAS) ---
    const allInputs = [
        els.nomeCliente, els.organizacao, els.organizacaoTipo, 
        els.telefone, els.negociadoras, els.vendaValorObs,
        els.qtyTickets, els.qtyTablets, els.qtyNitro, els.tipoValor
    ].filter(el => el);

    const inputMap = new Map(allInputs.map((input, index) => [input.id, index]));

    function handleEnterKey(e, input) {
        if (e.key !== 'Enter') return;
        
        e.preventDefault();
        
        if (currentTourStep > 0 && currentTourStep <= tourSteps.length) {
            const targetStepIndex = currentTourStep - 1; 
            
            if (tourSteps[targetStepIndex] && tourSteps[targetStepIndex].target === input) {
                nextStep();
            } else {
                advanceInputFocus(input);
            }
            return;
        }
        
        advanceInputFocus(input);
    }
    
    function advanceInputFocus(input) {
        const currentIndex = inputMap.get(input.id);
        if (currentIndex !== undefined) {
            let nextIndex = currentIndex + 1;
            let next = allInputs[nextIndex];
            
            while (next && next.readOnly) {
                nextIndex++;
                next = allInputs[nextIndex];
            }

            if (next) {
                next.focus();
            } else {
                els.calcBtn.focus();
            }
        }
    }


    allInputs.forEach(input => {
        input.addEventListener('keydown', e => handleEnterKey(e, input));
    });
    // --- FIM L√≥gica de Enter para Avan√ßar ---


    // Event Listeners

    els.calcBtn.addEventListener('click',()=>renderResults(calculateTotals()));
    els.registerBtn.addEventListener('click', handleSaleSubmission); // CHAMA A FUN√á√ÉO QUE GERENCIA EDI√á√ÉO/REGISTRO
    
    els.resetBtn.addEventListener('click', () => clearAllFields(true)); 
    els.discordBtn.addEventListener('click', generateDiscordFormat);
    
    els.telefone.addEventListener('input', formatarTelefone);
    
    els.nomeCliente.addEventListener('input', capitalizeWords);
    els.organizacao.addEventListener('input', capitalizeWords);
    els.negociadoras.addEventListener('input', capitalizeWords);
    els.vendaValorObs.addEventListener('input', capitalizeWords);
    
    els.tutorialBtn.addEventListener('click', () => {
        startTour(0); 
    });

    els.csvBtn.addEventListener('click',()=>{
      const out=calculateTotals();
      if(out.valorTotalGeral <= 0 && out.qTickets === 0 && out.qTablets === 0 && out.qNitro === 0) {
        alert("N√£o h√° dados de c√°lculo para exportar.");
        return;
      }
      const rows=[['Material/Produto','Quantidade ou Valor']];
      for(const[k,v]of Object.entries(out.totals))rows.push([k,v]);
      for(const[k,v]of Object.entries(out.valoresTotais))rows.push([k,`R$ ${v}`]);
      rows.push(['Valor Total Geral',`R$ ${out.valorTotalGeral}`]);
      const csv=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');a.href=url;a.download='materiais_valores.csv';a.click();URL.revokeObjectURL(url);
    });

    els.clearHistoryBtn.addEventListener('click',()=>{
      if(confirm('Tem certeza que deseja limpar todo o Hist√≥rico de Vendas? Esta a√ß√£o n√£o pode ser desfeita.')) {
        els.salesHistory.innerHTML = '';
      }
    });

    els.themeBtn.addEventListener('click',()=>{
      document.body.classList.toggle('dark');
      document.body.classList.toggle('light');
      els.themeBtn.textContent=document.body.classList.contains('dark')?'‚òÄÔ∏è Modo Claro':'üåô Modo Noturno';
      
      if (els.appLogo) {
        if (document.body.classList.contains('dark')) {
          els.appLogo.src = logoDarkModeSrc;
        } else {
          els.appLogo.src = logoLightModeSrc;
        }
      }
    });
    
    els.enterBtn.addEventListener('click', () => {
        els.welcomeScreen.classList.add('hidden');
        
        setTimeout(() => {
            els.welcomeScreen.style.display = 'none';
            els.mainCard.style.display = 'block';
        }, 500); 
    });
    
    document.addEventListener('DOMContentLoaded', () => {
        if (els.appLogo) {
            if (document.body.classList.contains('dark')) {
                els.appLogo.src = logoDarkModeSrc;
            } else {
                els.appLogo.src = logoLightModeSrc;
            }
        }
        
        els.mainCard.style.display = 'none';
        els.welcomeScreen.style.display = 'flex';
    });
    
    els.toggleHistoryBtn.addEventListener('click', () => toggleView(true));
    els.toggleCalcBtn.addEventListener('click', () => toggleView(false));
  </script>
</body>
</html>