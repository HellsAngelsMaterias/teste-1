<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <link rel="icon" type="image/png" href="logo-dark.png">
  
  <title>Hells Angels</title>
  <style>
    :root {
      --cor-fundo: #fff0f6;
      --cor-texto: #4a0033;
      --cor-principal: #e60073;
      --cor-card: #ffffff;
      --cor-borda: #ffb3d9;
      --cor-btn-primario: #e60073;
      --cor-btn-texto: #fff;
      --cor-btn-secundario: #ffd6eb;
      --cor-btn-secundario-texto: #4a0033;
      --cor-erro: #cc0000;
      /* NOVO: Cor para o brilho pulsante */
      --cor-glow-pulsante: rgba(230, 0, 115, 0.8); /* Cor Principal com opacidade */
    }

    body.dark {
      --cor-fundo: #1a000d; 
      --cor-texto: #ffccf0; 
      --cor-principal: #ff0080; 
      --cor-card: #2c001a; 
      --cor-borda: #e60073; 
      --cor-btn-primario: #ff0080; 
      --cor-btn-texto: #fff;
      --cor-btn-secundario: #4d002a; 
      --cor-btn-secundario-texto: #ffccf0; 
      /* NOVO: Cor para o brilho pulsante no modo escuro */
      --cor-glow-pulsante: rgba(255, 0, 128, 0.6); /* Cor Principal Escura com opacidade */
    }
    
    body.dark input[type=number], body.dark input[type=text], body.dark select {
      background: #33001f;
      color: var(--cor-texto);
      border: 1px solid var(--cor-borda);
    }
    
    /* --- ESTILO PARA INPUT DATALIST (Foco Rosa/Roxo) --- */
    input[list]:focus, input[list]:hover {
        border-color: var(--cor-principal) !important; 
        box-shadow: 0 0 5px rgba(230, 0, 115, 0.4); 
    }
    
    /* --- NOVO ESTILO PARA DATALIST (Sugestões de Organização) --- */
    input[list] {
        position: relative;
        z-index: 1; 
    }
    
    input[list]::-webkit-calendar-picker-indicator {
        display: none;
    }
    /* --- FIM NOVO ESTILO PARA DATALIST --- */
    
    /* --- NOVO: Estilo para a dica de sugestão da Organização --- */
    .suggestion-tip {
        font-size: 11px;
        color: var(--cor-principal); /* Usa a cor principal para destaque */
        margin-top: 4px;
        margin-bottom: 0;
        font-weight: 500;
        opacity: 0.8;
    }
    /* --- FIM NOVO: Estilo para a dica de sugestão da Organização --- */
    
    /* --- ESTILOS TOUR --- */
    .tour-tooltip {
      position: absolute;
      background: var(--cor-principal);
      color: var(--cor-btn-texto);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      max-width: 300px;
      text-align: left;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 10002;
    }

    .tour-tooltip.active {
      opacity: 1;
      transform: translateY(0);
    }

    .tour-tooltip h4 {
        margin: 0 0 5px;
        font-size: 16px;
        color: var(--cor-btn-texto);
    }
    .tour-tooltip p {
        margin: 0;
        font-size: 14px;
        margin-bottom: 10px;
    }
    
    .tour-tooltip button {
        background: var(--cor-btn-secundario);
        color: var(--cor-btn-secundario-texto);
        padding: 6px 10px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        margin-right: 8px;
    }
    
    .tour-highlight {
      box-shadow: 0 0 0 3px rgba(230,0,115,0.6), 0 0 10px rgba(230,0,115,0.5);
      position: relative;
      z-index: 10001;
    }
    /* --- FIM ESTILOS TOUR --- */
    
    /* --- ESTILO PARA CAMPO INVÁLIDO --- */
    input.input-invalido, select.input-invalido {
        border: 2px solid var(--cor-erro) !important;
        box-shadow: 0 0 4px var(--cor-erro);
    }
    /* --- FIM ESTILO PARA CAMPO INVÁLIDO --- */

    
    /* Container para a logo */
    #logoLink {
        position: fixed;
        top: 16px; 
        left: 16px; 
        width: auto; 
        max-height: 80px; 
        cursor: pointer;
        z-index: 9998; 
    }
    
    /* Ajuste na logo superior */
    .app-logo {
      max-height: 80px; 
      width: auto;
      transition: opacity 0.3s ease, filter 0.3s ease; /* Adicionado filter para a transição do hover */
      display: block; 
    }
    
    /* NOVO: Efeito de iluminação ao passar o mouse na Logo (na calculadora) */
    #appLogo:hover {
        /* Brilho da logo ao passar o mouse */
        filter: drop-shadow(0 0 8px var(--cor-principal)) drop-shadow(0 0 15px var(--cor-glow-pulsante));
        opacity: 0.9;
    }

    
    /* --- Estilo para a imagem na tela de boas-vindas --- */
    #welcomeLogo {
      max-width: 80%;
      max-height: 120px; 
      margin-bottom: 25px;
      display: block;
      /* NÃO ADICIONAR EFEITO DE HOVER AQUI */
    }
    
    #welcomeScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--cor-card);
      z-index: 10000; 
      display: none; 
      flex-direction: column;
      justify-content: center; 
      align-items: center;
      text-align: center;
      transition: opacity 0.5s ease;
      padding: 20px; 
      box-sizing: border-box; 
    }
    
    #welcomeScreen.show {
        display: flex; 
    }

    #welcomeScreen.hidden {
      opacity: 0;
      pointer-events: none; 
    }
    
    #welcomeScreen h2 {
      font-size: 36px;
      margin-top: 10px; 
      margin-bottom: 20px;
      color: var(--cor-principal);
    }
    
    #welcomeScreen button {
      padding: 12px 24px;
      font-size: 18px;
      border-radius: 10px;
      margin-top: 10px;
    }


    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 960px;
      margin: 24px auto;
      padding: 20px;
      background: var(--cor-fundo);
      color: var(--cor-texto);
      transition: background 0.25s ease, color 0.25s ease;
    }
    
    /* Garante que o conteúdo principal comece escondido e só apareça se JS/Welcome Screen não funcionar */
    #mainCard {
        display: block; 
    }

    h1 {
      margin: 0 0 12px;
      font-size: 24px;
      font-weight: 700;
      color: var(--cor-principal);
      text-align: center;
    }

    h2 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--cor-principal);
    }
    
    h3 {
        color: var(--cor-principal); 
        font-weight:600; 
        margin-top: 16px;
    }

    .card {
      background: var(--cor-card);
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 1px solid var(--cor-borda);
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin: 10px 0 6px;
      font-weight: 600;
      color: var(--cor-principal);
    }

    input[type=number], input[type=text], select {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid var(--cor-borda);
      background: #fff;
      color: var(--cor-texto);
      font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    
    input[type=number] {
        width: 140px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      margin-top: 12px;
    }
    
    .grid-venda {
        grid-template-columns: 1fr 1fr;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 14px;
    }

    th, td {
      padding: 6px; /* Reduzido o padding para caber mais na tela do celular */
      border-bottom: 1px solid var(--cor-borda);
      text-align: left;
    }

    th {
      background: var(--cor-btn-secundario);
      color: var(--cor-btn-secundario-texto);
      font-weight: 600;
    }
    
    
/* --- NOVO ESTILO PARA RESPONSIVIDADE DA TABELA --- */
.history-table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    width: 100%;
    margin-top: 8px;
}

/* Garante que o container interno não atrapalhe a rolagem */
#historyBackground {
    overflow: hidden;
}

/* Mantém a tabela com comportamento de tabela e largura controlada */
#historyCard table {
    width: 100%;
    display: table;
    border-collapse: collapse;
    table-layout: fixed; /* ajuda a manter colunas alinhadas */
    min-width: 900px; /* força scroll em telas pequenas mantendo alinhamento */
}

/* Estilo base para células */
#historyCard th, #historyCard td {
    padding: 8px 10px;
    vertical-align: middle;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 13px;
}

/* Ajuste para a linha de data/hora (duas linhas dentro da mesma célula) */
.history-datetime-line {
    display: block;
    line-height: 1.1;
    font-size: 12px;
}

/* Faz com que valores longos quebrem visualmente melhor em células menores quando necessário */
@media (max-width: 700px) {
    #historyCard th, #historyCard td {
        font-size: 12px;
    }
    #historyCard th:nth-child(5), #historyCard td:nth-child(5) { width: 320px; }
}
/* --- FIM NOVO ESTILO PARA RESPONSIVIDADE DA TABELA --- */



    .actions {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    button {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: opacity 0.2s ease, box-shadow 0.3s ease; /* Adicionado box-shadow para transição do glow */
    }

    button:hover { opacity: 0.85; }
    
    /* NOVO: Efeito de brilho pulsante para o botão principal (Calcular/Registrar) */
    .primary, .success {
        animation: pulse-glow 2s infinite ease-in-out;
    }
    
    /* NOVO: Keyframes para o brilho pulsante */
    @keyframes pulse-glow {
        0% {
            box-shadow: 0 0 0 rgba(0, 0, 0, 0); 
        }
        50% {
            box-shadow: 0 0 10px var(--cor-glow-pulsante), 0 0 20px var(--cor-glow-pulsante); 
        }
        100% {
            box-shadow: 0 0 0 rgba(0, 0, 0, 0); 
        }
    }

    .primary { background: var(--cor-btn-primario); color: var(--cor-btn-texto); }
    .muted { background: var(--cor-btn-secundario); color: var(--cor-btn-secundario-texto); }
    .success { background: #00b33c; color: #fff; }
    .danger { background: var(--cor-erro); color: #fff; } /* Novo: Botão de Perigo */

    /* Container para agrupar e posicionar botões (Modo Noturno e Tutorial) */
    .top-right-controls {
        position: fixed;
        top: 16px;
        right: 16px;
        display: flex;
        gap: 10px;
        z-index: 9999;
    }

    /* Estilo base para botões de controle fixos */
    .control-btn {
        padding: 10px 14px;
        border-radius: 10px;
        background: var(--cor-btn-primario);
        color: var(--cor-btn-texto);
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        border: none;
        transition: opacity 0.2s ease;
        /* ANIMAÇÃO pulse-glow REMOVIDA DAQUI */
    }
    .control-btn:hover {
        opacity: 0.85;
    }
    
    /* --- Estilo para o Fundo do Histórico --- */
    #historyBackground {
      /* ALTERAÇÃO: Fundo semi-transparente (70%) */
      background: rgba(255, 255, 255, 0.7); 
      position: relative; 
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 1px solid var(--cor-borda);
      margin-bottom: 20px;
      min-height: 400px; 
      overflow: hidden;
    }
    
    #historyBackground img {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: auto;
      opacity: 0.3; /* ALTERAÇÃO: Aumentado para maior visibilidade */ 
      z-index: 1; 
      object-fit: contain; 
    }
    
    #historyBackground > * {
      position: relative; 
      z-index: 2;
    }
    
    #historyCard table {
        font-size: 12px;
    }
    
    /* --- CORREÇÃO DE ALINHAMENTO DAS CÉLULAS (Principal Alteração) --- */
    /* Garante que o conteúdo fique no topo para alinhar a borda inferior */
    
#historyCard th, #historyCard td {
    padding: 8px 6px;
    text-align: center;
    vertical-align: middle; /* Centraliza verticalmente */
    white-space: nowrap;    /* Evita quebras desnecessárias */
}

/* Corrige o bloco de data/hora */
#historyCard tr td:first-child {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    line-height: 1.2;
    padding: 4px 0;
}

.history-datetime-line {
    display: block;
    font-size: 12px;
}

    
    /* Estilo para cada linha do texto dentro da célula de Data/Hora */
    .history-datetime-line {
        display: block;
        line-height: 1.2; 
        padding: 6px 0 0 6px; /* Adiciona o padding de volta (topo e esquerda) */
    }
    
    /* Reduz o espaçamento vertical para compactar o texto na célula de Valor Total (que tem quebra de linha) */
    
.valor-total-cell {
    display: flex;
    flex-direction: column;
    align-items: center;      /* Centraliza horizontalmente */
    justify-content: center;  /* Centraliza verticalmente */
    padding: 4px 0;
    line-height: 1.3;
    text-align: center;
}

.valor-total-cell span {
    display: block;
}

.valor-obs-text {
    font-size: 11px;
    color: var(--cor-principal);
    margin-top: 2px; /* Pequeno espaçamento entre o valor e a observação */
}

    
    /* --- FIM CORREÇÃO DE ALINHAMENTO --- */
    
    
    /* Estilo para colocar os botões do histórico na mesma linha (Responsivo) */
    .history-actions-cell {
        display: flex;
        gap: 5px; /* Espaçamento entre os botões */
        flex-wrap: nowrap; /* Garante que fiquem na mesma linha */
        padding-top: 4px; /* Ajuste para o padding das outras células */
    }
    
    .history-actions-cell button {
        padding: 4px 8px;
        font-size: 11px;
        margin-top: 2px; /* Pequeno ajuste de margem */
        border-radius: 4px;
        white-space: nowrap; /* Impede a quebra de linha dos botões */
    }

    /* --- Estilos para Notificação Toast --- */
    #toast-container {
        position: fixed;
        bottom: 20px; 
        right: 20px; 
        z-index: 10005; 
        display: flex;
        flex-direction: column-reverse; 
        gap: 10px; 
        align-items: flex-end; 
    }

    .toast {
        background-color: var(--cor-principal); 
        color: var(--cor-btn-texto);
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        opacity: 0;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        transform: translateY(20px); 
        max-width: 300px;
        min-width: 150px;
        text-align: center;
    }

    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }
    
    .toast.success {
        background-color: #00b33c; 
    }

    .toast.error {
        background-color: var(--cor-erro); 
    }
    
    .action-btn {
        padding: 4px 8px;
        font-size: 12px;
        margin-right: 0px; 
        border-radius: 4px;
    }
    
    /* Otimização para telas muito pequenas */
    @media (max-width: 500px) {
        body {
            padding: 10px;
            margin: 10px auto;
        }
        .top-right-controls {
            top: 10px;
            right: 10px;
        }
        .control-btn {
            padding: 8px 10px;
            font-size: 12px;
        }
        .grid {
            grid-template-columns: 1fr;
        }
        .grid-venda {
            grid-template-columns: 1fr;
        }
    }
    /* --- FIM Estilos para Notificação Toast --- */
  
/* --- ESTILO FINAL DA TABELA DE HISTÓRICO --- */
.history-table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    width: 100%;
    margin-top: 8px;
}

#historyCard table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    min-width: 900px;
    background: transparent; 
}

#historyCard th, #historyCard td {
    padding: 6px 8px; /* Aumentado de 4px 6px */
    text-align: center;
    vertical-align: middle;
    white-space: nowrap;
    font-size: 14px; /* Aumentado de 13px */
    border-bottom: 1px solid var(--cor-borda);
}

/* NOVO: Fundo para as células de dados para garantir a legibilidade */
#historyCard td {
    background: var(--cor-card); 
    opacity: 0.95; /* Leve transparência para manter o efeito do fundo */
}

body.dark #historyCard td {
    background: var(--cor-card); /* Cor do card escuro */
    opacity: 0.95;
}


/* Alinhamento individual por coluna - larguras ajustadas */
#historyCard th:nth-child(1), #historyCard td:nth-child(1) { width: 100px; }   /* Data/Hora - Aumentado */
#historyCard th:nth-child(2), #historyCard td:nth-child(2) { width: 140px; }  /* Cliente - Aumentado */
#historyCard th:nth-child(3), #historyCard td:nth-child(3) { width: 160px; }  /* Organização */
#historyCard th:nth-child(4), #historyCard td:nth-child(4) { width: 110px; }  /* Telefone */
#historyCard th:nth-child(5), #historyCard td:nth-child(5) { width: 280px; }  /* Produtos - Aumentado */
#historyCard th:nth-child(6), #historyCard td:nth-child(6) { width: 150px; }  /* Valor - Aumentado */
#historyCard th:nth-child(7), #historyCard td:nth-child(7) { width: 130px; }  /* Negociadoras */
#historyCard th:nth-child(8), #historyCard td:nth-child(8) { width: 150px; }  /* Ações */

/* Data e hora */
.history-datetime-line {
    display: block;
    line-height: 1.2; /* Aumentado */
    font-size: 13px; /* Aumentado */
}

/* Valor Total - tornando o valor em negrito */
.valor-total-cell span:first-child {
    font-weight: 700; /* Negrito */
}

.valor-obs-text {
    font-size: 12px; /* Aumentado */
    color: var(--cor-principal);
}

/* Botões de ações */
.history-actions-cell {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}

.history-actions-cell button {
    padding: 3px 6px;
    font-size: 11px;
    border-radius: 4px;
    white-space: nowrap;
}

/* Aumenta altura total da linha */
#historyCard tr {
    height: 40px;
}

/* NOVO: Estilo para o cabeçalho TH */
#historyCard th {
    background: var(--cor-principal); /* Usa a cor principal para o cabeçalho */
    color: var(--cor-btn-texto);     /* Texto branco */
}

/* NOVO: Fundo semi-transparente para modo escuro */
body.dark #historyBackground {
  /* Cor escura do card #2c001a (que é 44, 0, 26 em RGB) com 70% de opacidade */
  background: rgba(44, 0, 26, 0.7); 
}
/* --- FIM DO ESTILO FINAL DA TABELA DE HISTÓRICO --- */

</style>
</head>
<body class="light">
  
  <a href="#" id="logoLink">
    <img id="appLogo" src="logo-dark.png" alt="Hells Angels Logo" class="app-logo">
  </a>

  <div id="welcomeScreen"> 
      <img id="welcomeLogo" src="logo-dark.png" alt="Welcome Logo"> 
      <h2 style="font-weight: 900;">Bem-vindo(a)</h2>
      <p style="margin-bottom: 20px; font-size: 16px;">Calculadora e Registro de Vendas Hells Angels</p>
      <button id="enterBtn" class="primary">Entrar no Site</button>
  </div>
  
  <div class="top-right-controls">
      <button class="control-btn" id="tutorialBtn">💡 Tutorial</button> 
      <button class="control-btn" id="themeBtn">🌙 Modo Noturno</button>
  </div>

  <div id="authScreen" class="card" style="max-width: 400px; margin: 100px auto 20px auto; display: none;">
      <h2>Autenticação de Usuário</h2>
      
      <label for="username">Nome de Usuário:</label>
      <input id="username" type="text" placeholder="Seu nome de usuário">
      
      <label for="password">Senha:</label>
      <input id="password" type="password" placeholder="Sua senha">
      
      <div class="actions">
          <button id="loginBtn" class="primary">Entrar</button>
          <button id="registerUserBtn" class="muted">Cadastrar</button>
      </div>
      <p id="authMessage" style="color: var(--cor-erro); margin-top: 10px;"></p>
  </div>
  <div class="card" id="mainCard" style="display:none">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <h1>Calculadora e Registro de Vendas Hells Angels</h1>
        <button id="logoutBtn" class="danger" style="animation: none;">Sair</button>
    </div>
    
    <div class="card-venda">
        <h2>Dados da Venda</h2>
        <div class="grid grid-venda">
            <div>
                <label for="nomeCliente">Nome:</label>
                <input id="nomeCliente" type="text" value="">
            </div>
            <div>
                <label for="dataVenda">Data:</label>
                <input id="dataVenda" type="text" readonly> 
            </div>
            
            <div>
                <label for="organizacao">Organização:</label>
                <input id="organizacao" type="text" value="" list="sugestoesOrganizacao">
                
                <p class="suggestion-tip">Digite para ver sugestões de organizações.</p>
                
                <datalist id="sugestoesOrganizacao">
                    <option value="Serpents"></option>
                    <option value="Nox"></option>
                    <option value="NKT"></option>
                    <option value="Ruptura"></option>
                    <option value="Midnight"></option>
                    <option value="Meraki"></option>
                    <option value="Lotus"></option>
                    <option value="Hydra"></option>
                    <option value="Hooligans"></option>
                    <option value="Families"></option>
                    <option value="Cartel"></option>
                    <option value="Blood Street"></option>
                    <option value="Blood Reapers"></option>
                    <option value="Blue Diamond"></option>
                    <option value="Black Heart"></option>
                    <option value="Ballas"></option>
                    <option value="Aura"></option>
                    <option value="Anarquia"></option>
                    <option value="8 Anjo"></option>
                    <option value="Vagos"></option>
                    <option value="Vertice"></option>
                    <option value="Void"></option>
                    <option value="Solo"></option>
                </datalist>
            </div>
            <div>
                <label for="organizacaoTipo">Opção (CNPJ/CPF):</label>
                <select id="organizacaoTipo">
                    <option value="CNPJ">CNPJ</option>
                    <option value="CPF">CPF</option>
                    <option value="OUTROS">Outros</option>
                </select>
            </div>
            
            <div>
                <label for="telefone">Telefone:</label>
                <input id="telefone" type="text" value="" maxlength="13"> 
            </div>
            
            <div>
                <label for="negociadoras">Negociadoras:</label>
                <input id="negociadoras" type="text" value="">
            </div>
            <div style="grid-column: 1 / -1;">
                <label for="vendaValorObs">Valor - Observação (Como foi o pagamento):</label>
                <input id="vendaValorObs" type="text" value="">
            </div>
        </div>
    </div>
    
    <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--cor-borda);">

    <h2>Cálculo de Produtos</h2>
    <p class="small">Informe quantos produtos deseja fabricar/vender e escolha o tipo de valor.</p>

    <div class="grid">
      <div>
        <label for="qtyTickets">Quantidade de Tickets</label>
        <input id="qtyTickets" type="number" min="0" value="">
      </div>
      <div>
        <label for="qtyTablets">Quantidade de Tablets</label>
        <input id="qtyTablets" type="number" min="0" value="">
      </div>
      <div>
        <label for="qtyNitro">Quantidade de Nitro</label>
        <input id="qtyNitro" type="number" min="0" value="">
      </div>
      <div>
        <label for="tipoValor">Tipo de Valor</label>
        <select id="tipoValor">
          <option value="limpo">Dinheiro Limpo</option>
          <option value="sujo">Dinheiro Sujo</option>
          <option value="limpo_alianca">Limpo (Aliança)</option>
          <option value="sujo_alianca">Sujo (Aliança)</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <button id="calcBtn" class="primary">Calcular</button>
      <button id="resetBtn" class="muted">Limpar Campos</button>
      <button id="registerBtn" class="success">Registrar Venda</button>
      <button id="toggleHistoryBtn" class="muted">Ver Histórico</button>
      <button id="csvBtn" class="muted">Exportar CSV</button>
      <button id="discordBtnCalc" class="muted">Discord</button> 
    </div>

    <div id="resultsContainer">
      <div id="results" style="margin-top:16px;display:none">
        <h3>Totais necessários</h3>
        <table>
          <thead><tr><th>Material</th><th>Quantidade total</th></tr></thead>
          <tbody id="resultsBody"></tbody>
        </table>

        <h3>Valores Estimados</h3>
        <table>
          <thead><tr><th>Produto</th><th>Valor Total</th></tr></thead>
          <tbody id="valuesBody"></tbody>
          <tfoot>
            <tr><th>Total Geral</th><th id="valorTotalGeral">R$ 0</th></tr>
          </tfoot>
        </table>
        <p class="result-note" style="font-size: 12px; margin-top: 8px;">Os valores variam conforme o tipo selecionado (limpo, sujo, aliança).</p>
      </div>
    </div>
  </div>

  <div class="card" id="historyCard" style="display:none">
      <div id="historyBackground" class="card">
        <h2>Histórico de Vendas Registradas</h2>
        <img id="historyImg" src="logo-dark.png" alt="Fundo Histórico"> 
        
        <input type="text" id="filtroHistorico" placeholder="🔍 Pesquisar no histórico (Nome, Data, Item, etc.)" style="margin-bottom: 10px; width: 100%;">
        
        <div class="actions">
          <button id="clearHistoryBtn" class="muted">Limpar Histórico</button>
          <button id="toggleCalcBtn" class="muted">Voltar à Calculadora</button>
        </div>
        <div class="history-table-wrapper"><table id="historicoVendas">
          <thead>
              <tr>
                  <th>Data/Hora</th>
                  <th>Cliente</th>
                  <th>Organização/Tipo</th>
                  <th>Telefone</th>
                  <th>Produtos (Unidade)</th>
                  <th>Valor Total</th>
                  <th>Negociadoras</th>
                  <th>Registrado Por</th> <th>Ações</th> 
              </tr>
          </thead>
          <tbody id="salesHistory"></tbody>
        </table></div>
      </div>
  </div>
  
  <div id="toast-container"></div>
  
  <script type="module">
    // ------------------------------------
    // 1. IMPORTAÇÕES E CONFIGURAÇÃO FIREBASE
    // ------------------------------------
    // URLs de importação do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    
    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAhDVBfXoO_Rdi3e-trdbaaPppwDkTDgVc",
      authDomain: "hells-angels-438c2.firebaseapp.com",
      databaseURL: "https://hells-angels-438c2-default-rtdb.firebaseio.com/",
      projectId: "hells-angels-438c2",
      storageBucket: "hells-angels-438c2.firebasestorage.app",
      messagingSenderId: "429406215315",
      appId: "1:429406215315:web:96b68b172247824b308166",
      measurementId: "G-CR415MEY32"
    };

    // Inicialização
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    
    // VARIÁVEIS GLOBAIS
    let vendas = []; // O histórico será preenchido pelo Firebase
    let vendaEmEdicaoId = null; 
    let currentUser = null; // Para guardar o usuário logado
    
    // Funções de formatação e valores (código original)
    // ... (restante do código original)
    
    
    const perUnit = {
      tickets: { moneyBruto: 525 },
      tablets: { cobre: 20, plastico: 40, fita_adesiva: 2, lixo_eletronico: 2 },
      nitro: { aluminio: 20, cobre: 20, vidro: 45, fita_adesiva: 1, porca: 1, parafuso: 1 }
    };

    const valores = {
      tablets: { limpo: 17000, sujo: 20000, limpo_alianca: 15000, sujo_alianca: 18000 },
      tickets: { limpo: 9800, sujo: 11700, limpo_alianca: 8000, sujo_alianca: 10000 },
      nitro: { limpo: 42500, sujo: 50000, limpo_alianca: 38000, sujo_alianca: 45000 }
    };
    
    const valorDescricao = {
        'limpo': 'Dinheiro Limpo',
        'sujo': 'Dinheiro Sujo',
        'limpo_alianca': 'Limpo (Aliança)',
        'sujo_alianca': 'Sujo (Aliança)'
    };
    
    // Usando 'logo-dark.png' como placeholder para todas as imagens
    const logoLightModeSrc = "logo-dark.png"; 
    const logoDarkModeSrc = "logo-dark.png"; 
    const historyBackgroundSrc = "logo-dark.png"; 
    const welcomeLogoSrc = "logo-dark.png"; 
    
    function showToast(message, type = 'default', duration = 3000) {
        const container = document.getElementById('toast-container');
        if (!container) return; 

        const toast = document.createElement('div');
        toast.classList.add('toast');
        if (type) {
            toast.classList.add(type);
        }
        toast.textContent = message;
        
        container.appendChild(toast);
        
        void toast.offsetWidth; 
        toast.classList.add('show');

        setTimeout(() => {
            toast.classList.remove('show');
            
            setTimeout(() => {
                toast.remove();
            }, 300); 
        }, duration);
    }
    
    // REMOVIDO: loadVendas() e saveVendas() - Agora usamos Firebase

    const els = {
      // Campos do Cálculo
      qtyTickets: document.getElementById('qtyTickets'),
      qtyTablets: document.getElementById('qtyTablets'),
      qtyNitro: document.getElementById('qtyNitro'),
      tipoValor: document.getElementById('tipoValor'),
      
      // Campos do Cliente/Venda
      nomeCliente: document.getElementById('nomeCliente'),
      dataVenda: document.getElementById('dataVenda'),
      organizacaoTipo: document.getElementById('organizacaoTipo'),
      organizacao: document.getElementById('organizacao'),
      telefone: document.getElementById('telefone'),
      negociadoras: document.getElementById('negociadoras'),
      vendaValorObs: document.getElementById('vendaValorObs'),
      
      // Botões
      calcBtn: document.getElementById('calcBtn'),
      resetBtn: document.getElementById('resetBtn'),
      csvBtn: document.getElementById('csvBtn'),
      registerBtn: document.getElementById('registerBtn'),
      discordBtnCalc: document.getElementById('discordBtnCalc'), 
      
      // Resultados e Histórico
      results: document.getElementById('results'),
      resultsBody: document.getElementById('resultsBody'),
      valuesBody: document.getElementById('valuesBody'),
      valorTotalGeral: document.getElementById('valorTotalGeral'),
      salesHistory: document.getElementById('salesHistory'),
      clearHistoryBtn: document.getElementById('clearHistoryBtn'),
      filtroHistorico: document.getElementById('filtroHistorico'), 
      
      // Botões de controle fixos
      themeBtn: document.getElementById('themeBtn'),
      tutorialBtn: document.getElementById('tutorialBtn'), 
      
      mainCard: document.getElementById('mainCard'), 
      historyCard: document.getElementById('historyCard'), 
      toggleHistoryBtn: document.getElementById('toggleHistoryBtn'), 
      toggleCalcBtn: document.getElementById('toggleCalcBtn'),
      
      // Elementos da tela de boas-vindas
      welcomeScreen: document.getElementById('welcomeScreen'),
      enterBtn: document.getElementById('enterBtn'),
      
      // Elemento da Logo
      appLogo: document.getElementById('appLogo'), 
      logoLink: document.getElementById('logoLink'), 
      
      // NOVO: Elementos de Autenticação
      authScreen: document.getElementById('authScreen'),
      username: document.getElementById('username'),
      password: document.getElementById('password'),
      loginBtn: document.getElementById('loginBtn'),
      registerUserBtn: document.getElementById('registerUserBtn'),
      authMessage: document.getElementById('authMessage'),
      logoutBtn: document.getElementById('logoutBtn'),
    };

    // --- VARIÁVEIS DO TOUR ---
    let currentTourStep = 0; 
    const tourSteps = [
        { target: els.nomeCliente, title: 'Passo 1: Nome do Cliente (1/17)', text: 'Comece digitando o nome do comprador. Pressione **Enter** para avançar.' },
        { target: els.organizacao, title: 'Passo 2: Organização (2/17)', text: 'Informe a Organização/Empresa do cliente. Pressione **Enter** ou **Tab** (com sugestão única) para avançar.' },
        { target: els.organizacaoTipo, title: 'Passo 3: Tipo de Documento (3/17)', text: 'Selecione o tipo de identificação do cliente (CNPJ/CPF).' },
        { target: els.telefone, title: 'Passo 4: Telefone (4/17)', text: 'Digite o telefone do cliente. Será formatado automaticamente.' },
        { target: els.negociadoras, title: 'Passo 5: Negociadoras (5/17)', text: 'Se houver mais de uma, separe por vírgula. Ex: Ana, Bruna, Carla.' },
        { target: els.vendaValorObs, title: 'Passo 6: Observação (6/17)', text: 'Detalhe como foi o pagamento (Pix, Transferência, etc.).' },
        { target: els.qtyTickets, title: 'Passo 7: Quantidade (7/17)', text: 'Informe a quantidade de **Tickets** que deseja vender/fabricar.' },
        { target: els.qtyTablets, title: 'Passo 8: Quantidade (8/17)', text: 'Informe a quantidade de **Tablets**.' },
        { target: els.qtyNitro, title: 'Passo 9: Quantidade (9/17)', text: 'Informe a quantidade de **Nitros**.' },
        { target: els.tipoValor, title: 'Passo 10: Tipo de Valor (10/17)', text: 'Escolha se o valor da venda é Limpo, Sujo ou se é uma venda para Aliança.' },
        { target: els.calcBtn, title: 'Passo 11: Calcular (11/17)', text: 'Clique em **Calcular** para ver os materiais necessários e o valor total estimado. Isso não registra a venda.' },
        { target: els.registerBtn, title: 'Passo 12: Registrar Venda (12/17)', text: 'Este botão salva a venda no histórico e deve ser usado após o cálculo.' },
        { target: els.toggleHistoryBtn, title: 'Passo 13: Ver Histórico (13/17)', text: 'Veja todas as vendas registradas, incluindo as opções de Editar e Apagar.' },
        { target: els.csvBtn, title: 'Passo 14: Exportar CSV (14/17)', text: 'Exporta os materiais e valores calculados para um arquivo CSV (planilha).' },
        { target: els.discordBtnCalc, title: 'Passo 15: Copiar Discord (15/17)', text: 'Copia o resumo da venda para o formato Discord, usando os dados e o cálculo atual.' },
        { target: els.resetBtn, title: 'Passo 16: Limpar Campos (16/17)', text: 'Apaga todos os dados inseridos e os resultados. Útil para começar uma nova venda.' },
        { target: document.getElementById('themeBtn'), title: 'Passo 17: Modo Noturno (17/17)', text: 'Finalizamos! Este botão permite alternar entre os temas Claro e Noturno.' }
    ];
    // --- FIM VARIÁVEIS DO TOUR ---
    
    
    // --- FUNÇÕES DE FORMATO (código original) ---
    function formatNome(key){return key.replace(/_/g,' ').replace(/(^|\s)\S/g,s=>s.toUpperCase());}
    function numberWithCommas(x){return (Number(x)||0).toLocaleString('pt-BR');}

    function capitalizeWords(event) {
        let input = event.target;
        let value = input.value;
        if (!value) return;

        const start = input.selectionStart;
        const end = input.selectionEnd;
        
        let formattedValue = value.toLowerCase().replace(/(^|\s)\S/g, (match) => {
            return match.toUpperCase();
        });

        input.value = formattedValue;
        input.setSelectionRange(start, end);
    }
    
    function formatarTelefone(event) {
        let input = event.target;
        let value = input.value.replace(/\D/g, ""); 
        
        const prefixo = "055"; 
        
        if (value.startsWith(prefixo)) {
            value = value.substring(3);
        }
        
        value = value.substring(0, 6); 
        
        let formattedValue = '';

        formattedValue += `(${prefixo}) `;

        if (value.length > 0) {
            formattedValue += value.substring(0, 3);
        }
        if (value.length > 3) {
            formattedValue += '-' + value.substring(3, 6);
        }

        input.value = formattedValue;
        input.maxLength = 13; 
    }

    function updateDateTime() {
        const now = new Date();
        const day = String(now.getDate()).padStart(2, '0');
        const month = String(now.getMonth() + 1).padStart(2, '0');
        
        const hora = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }); 
        
        els.dataVenda.value = `${day}/${month} ${hora}`; 
    }
    
    setInterval(updateDateTime, 60000); 

    updateDateTime(); 
    
    function toggleView(showHistory) {
        // Checa se o usuário está logado antes de mudar a view
        if (!currentUser) {
            showToast("Você precisa estar logado para acessar o Histórico ou a Calculadora.", "error");
            return;
        }

        if (showHistory) {
            els.mainCard.style.display = 'none';
            els.historyCard.style.display = 'block';
            // renderHistorico é chamado automaticamente pelo listener do Firebase
        } else {
            els.mainCard.style.display = 'block';
            els.historyCard.style.display = 'none';
        }
        
        clearTour();
    }
    
    // --- FUNÇÕES DE PREENCHIMENTO AUTOMÁTICO PARA DATALIST (Organizacao) ---

    let ultimaSugestao = ''; 

    function checkSingleSuggestion() {
        const input = els.organizacao;
        const datalist = document.getElementById('sugestoesOrganizacao');
        const valor = input.value.toLowerCase().trim();
        
        ultimaSugestao = ''; 

        if (!valor) return; 

        const opcoes = Array.from(datalist.options);
        const sugestoesValidas = opcoes.filter(option => 
            option.value.toLowerCase().startsWith(valor)
        );

        if (sugestoesValidas.length === 1) {
            ultimaSugestao = sugestoesValidas[0].value;
        }
    }

    function handleTabForSuggestion(e) {
        if (e.keyCode === 9 && ultimaSugestao) {
            e.preventDefault(); 
            
            els.organizacao.value = ultimaSugestao;
            
            capitalizeWords({ target: els.organizacao }); 
            
            ultimaSugestao = ''; 
            
            els.organizacaoTipo.focus();
        }
    }
    // --- FIM FUNÇÕES DE PREENCHIMENTO AUTOMÁTICO PARA DATALIST ---

    
    // --- FUNÇÕES DO TUTORIAL/TOUR ---
    function clearTour() {
        currentTourStep = 0; 
        const existingTooltip = document.querySelector('.tour-tooltip');
        if (existingTooltip) {
            existingTooltip.remove();
        }
        document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
    }

    function updateTooltip(target, title, text, stepIndex) {
        clearTour(); 

        const rect = target.getBoundingClientRect();
        const tooltip = document.createElement('div');
        tooltip.className = 'tour-tooltip active';
        
        const totalSteps = tourSteps.length;
        const buttonText = stepIndex < totalSteps - 1 ? 'Próximo (Enter)' : 'Finalizar';

        tooltip.innerHTML = `
            <h4>${title}</h4>
            <p>${text}</p>
            <button id="tourCloseBtn">Fechar</button>
            <button id="tourNextBtn" class="primary" style="float:right;">${buttonText}</button>
        `;
        
        document.body.appendChild(tooltip); 
        
        tooltip.querySelector('#tourCloseBtn').addEventListener('click', clearTour);
        tooltip.querySelector('#tourNextBtn').addEventListener('click', () => {
            if (stepIndex < totalSteps - 1) {
                nextStep();
            } else {
                clearTour();
            }
        });

        const tooltipWidth = tooltip.offsetWidth;
        const tooltipHeight = tooltip.offsetHeight;
        const targetCenterX = rect.left + rect.width / 2;
        let tooltipLeft = targetCenterX - tooltipWidth / 2;
        
        if (tooltipLeft < 10) tooltipLeft = 10;
        if (tooltipLeft + tooltipWidth > window.innerWidth - 10) {
            tooltipLeft = window.innerWidth - tooltipWidth - 10;
        }

        let tooltipTop = rect.top - tooltipHeight - 15;
        
        if (tooltipTop < 10) {
            tooltipTop = rect.bottom + 15;
        }

        tooltip.style.left = `${tooltipLeft}px`;
        tooltip.style.top = `${tooltipTop + window.scrollY}px`;

        target.classList.add('tour-highlight');
        currentTourStep = stepIndex + 1;
        
        if (target.tagName === 'INPUT' || target.tagName === 'SELECT') {
            target.focus();
        } else {
            tooltip.querySelector('#tourNextBtn').focus();
        }
        
    }
    
    function startTour(stepIndex) {
        clearAllFields(); 
        
        // Garante que o usuário esteja na tela principal se o login foi feito
        if(currentUser) {
            els.mainCard.style.display = 'block';
            els.historyCard.style.display = 'none';
        }
        
        els.welcomeScreen.classList.add('hidden');
        
        setTimeout(() => {
            els.welcomeScreen.classList.remove('show');
            els.welcomeScreen.style.display = 'none';
            if (stepIndex < tourSteps.length) {
                const step = tourSteps[stepIndex];
                updateTooltip(step.target, step.title, step.text, stepIndex);
            }
        }, 500); 
    }
    
    function nextStep() {
        if (currentTourStep > 0 && currentTourStep < tourSteps.length) {
            const nextIndex = currentTourStep;
            const step = tourSteps[nextIndex];
            updateTooltip(step.target, step.title, step.text, nextIndex);
        } else if (currentTourStep === tourSteps.length) {
            clearTour(); 
        }
    }
    
    // --- FIM FUNÇÕES DO TUTORIAL/TOUR ---

    function calculateTotals() {
      const qTickets = Math.max(0, Math.floor(Number(els.qtyTickets.value) || 0));
      const qTablets = Math.max(0, Math.floor(Number(els.qtyTablets.value) || 0));
      const qNitro = Math.max(0, Math.floor(Number(els.qtyNitro.value) || 0));
      const tipo = els.tipoValor.value;

      const totals = {};
      totals['Dinheiro Sujo (R$)'] = qTickets * perUnit.tickets.moneyBruto; 

      for (const [mat, qtd] of Object.entries(perUnit.tablets)) {
        totals[formatNome(mat)] = (totals[formatNome(mat)] || 0) + qtd * qTablets;
      }
      for (const [mat, qtd] of Object.entries(perUnit.nitro)) {
        totals[formatNome(mat)] = (totals[formatNome(mat)] || 0) + qtd * qNitro;
      }

      const valoresTotais = {};
      valoresTotais['Tickets'] = (valores.tickets?.[tipo] || 0) * qTickets;
      valoresTotais['Tablets'] = (valores.tablets?.[tipo] || 0) * qTablets;
      valoresTotais['Nitro'] = (valores.nitro?.[tipo] || 0) * qNitro;

      const valorTotalGeral = Object.values(valoresTotais).reduce((a,b)=>a+b,0);

      return { totals, valoresTotais, valorTotalGeral, qTickets, qTablets, qNitro, tipo };
    }

    function renderResults(data) {
      const { totals, valoresTotais, valorTotalGeral } = data;
      els.resultsBody.innerHTML = '';
      els.valuesBody.innerHTML = '';

      const keys = Object.keys(totals);
      keys.sort((a,b)=> (a.startsWith('D') ? -1 : a.localeCompare(b))); 

      for (const k of keys) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${k}</td><td>${numberWithCommas(totals[k])}</td>`;
        els.resultsBody.appendChild(tr);
      }

      for (const [produto, valor] of Object.entries(valoresTotais)) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${produto}</td><td>R$ ${numberWithCommas(valor)}</td>`;
        els.valuesBody.appendChild(tr);
      }

      els.valorTotalGeral.textContent = `R$ ${numberWithCommas(valorTotalGeral)}`;
      els.results.style.display = 'block';
    }
    
    // ------------------------------------
    // 2. FUNÇÕES FIREBASE E LÓGICA DE NEGÓCIO
    // ------------------------------------

    // Função auxiliar para criar um "e-mail de fachada" para o Firebase Auth
    function createFacadeEmail(username) {
        return `${username.toLowerCase().trim()}@hells.local`;
    }

    // --- AUTENTICAÇÃO ---

    async function handleCadastro() {
        const username = els.username.value.trim();
        const password = els.password.value;
        if (!username || !password) {
            els.authMessage.textContent = "Preencha Nome de Usuário e Senha.";
            return;
        }
        
        const email = createFacadeEmail(username);

        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            
            // Armazena o nome de usuário real no perfil do Firebase
            await updateProfile(userCredential.user, {
                displayName: username
            });

            els.authMessage.textContent = "";
            showToast("Cadastro realizado com sucesso! Fazendo login...", "success");
            // handleLoginSucess será chamado automaticamente pelo onAuthStateChanged
        } catch (error) {
            console.error("Erro no cadastro:", error);
            if (error.code === 'auth/email-already-in-use') {
                els.authMessage.textContent = `Usuário "${username}" já cadastrado. Tente Entrar.`;
            } else if (error.code === 'auth/weak-password') {
                els.authMessage.textContent = "Senha fraca (mínimo de 6 caracteres).";
            } else {
                // TRATAMENTO DE ERROS GENÉRICOS DE CONEXÃO
                els.authMessage.textContent = "Erro ao cadastrar. Verifique a conexão e as configurações do Firebase.";
            }
        }
    }

    async function handleLogin() {
        const username = els.username.value.trim();
        const password = els.password.value;
        if (!username || !password) {
            els.authMessage.textContent = "Preencha Nome de Usuário e Senha.";
            return;
        }
        
        const email = createFacadeEmail(username);

        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            els.authMessage.textContent = "";
            // handleLoginSucess será chamado automaticamente pelo onAuthStateChanged
            
        } catch (error) {
            console.error("Erro no login:", error);
            els.authMessage.textContent = "Nome de usuário ou senha incorretos.";
        }
    }

    function handleLoginSucess(user) {
        currentUser = user;
        showToast(`Bem-vindo, ${user.displayName || 'Usuário'}!`, "success");
        
        // Esconde telas e mostra o mainCard (calculadora)
        els.authScreen.style.display = 'none';
        els.welcomeScreen.style.display = 'none';
        els.mainCard.style.display = 'block';
        
        // Inicia a sincronização do histórico global
        setupGlobalHistoryListener();
    }

    function handleLogout() {
        auth.signOut();
        currentUser = null;
        vendas = [];
        
        // Esconde tudo e mostra a tela de autenticação
        els.mainCard.style.display = 'none';
        els.historyCard.style.display = 'none';
        els.authScreen.style.display = 'block';
        
        // Limpa campos de login
        els.username.value = '';
        els.password.value = '';
        els.authMessage.textContent = '';
        
        showToast("Sessão encerrada.", "info");
    }

    // --- HISTÓRICO GLOBAL (FIREBASE REALTIME DB) ---

    // Listener que sincroniza 'vendas' e re-renderiza o histórico para todos
    function setupGlobalHistoryListener() {
        const vendasRef = ref(db, 'vendas');
        
        onValue(vendasRef, (snapshot) => {
            const data = snapshot.val();
            
            if (data) {
                // Converte o objeto Firebase para array, mantendo o ID único
                vendas = Object.keys(data).map(key => ({
                    id: key, 
                    ...data[key]
                })).reverse(); // Mais novos primeiro
            } else {
                vendas = [];
            }
            
            // Renderiza se a tela de histórico estiver visível
            if (els.historyCard.style.display !== 'none') {
                 renderHistorico(els.filtroHistorico.value); 
            }
            
        }, (error) => {
            console.error("Erro ao sincronizar histórico: ", error);
            showToast("Erro ao carregar histórico global. Verifique as regras do DB.", "error");
        });
    }

    // Função de exclusão modificada para usar Firebase
    async function deleteVenda(firebaseId) {
        if (!currentUser) {
            showToast("Você deve estar logado para apagar vendas.", "error");
            return;
        }
        if (confirm("Tem certeza que deseja apagar este registro de venda?")) {
            try {
                const saleRef = ref(db, `vendas/${firebaseId}`);
                await remove(saleRef);
                showToast("Venda apagada do histórico global!", "error");
                // renderHistorico é chamado automaticamente pelo listener
            } catch (error) {
                console.error("Erro ao apagar venda no Firebase:", error);
                showToast("Erro ao apagar venda.", "error");
            }
        }
    }
    // EXPOE AO ESCOPO GLOBAL PARA O ONCLICK FUNCIONAR
    window.deleteVenda = deleteVenda;

    // Função de registro/edição modificada para usar Firebase
    async function registerSale() {
        if (!currentUser) {
            showToast("Você deve estar logado para registrar ou editar vendas.", "error");
            return;
        }
        
        if (!validateFields()) {
            return; 
        }
        
        const data = calculateTotals();
        const { valorTotalGeral, qTickets, qTablets, qNitro, tipo } = data;
        
        if (valorTotalGeral <= 0 && qTickets === 0 && qTablets === 0 && qNitro === 0) {
            showToast("O valor total da venda deve ser maior que R$ 0 ou ter produtos para registrar.", "error");
            return;
        }

        const nome = els.nomeCliente.value.trim() || 'N/A';
        const tipoOrg = els.organizacaoTipo.value; 
        const org = els.organizacao.value.trim() || 'N/A';
        const tel = els.telefone.value.trim() || 'N/A';
        const negociadoras = els.negociadoras.value.trim() || 'N/A';
        let valorObs = els.vendaValorObs.value.trim() || 'N/A';
        
        let descTipo = '';
        if (tipo !== 'limpo' && tipo !== 'limpo_alianca') {
            descTipo = valorDescricao[tipo] || '';
        }
        
        if (descTipo && valorObs.toLowerCase() !== 'n/a') {
            valorObs = `${descTipo} | ${valorObs}`;
        } else if (descTipo) {
            valorObs = descTipo;
        } else if (valorObs.toLowerCase() === 'n/a') {
            valorObs = 'N/A';
        }

        
        const dataHoraVenda = els.dataVenda.value; 

        const produtos = [];
        if(qTablets>0) produtos.push(`Tablet (${qTablets})`);
        if(qNitro>0) produtos.push(`Nitros (${qNitro})`);
        if(qTickets>0) produtos.push(`Tickets (${qTickets})`);
        
        const produtosStr = produtos.length > 0 ? produtos.join(', ') : 'Nenhum Produto';
        
        const newSaleData = {
            dataHora: dataHoraVenda, 
            cliente: nome,
            organizacao: `${tipoOrg} - ${org}`,
            telefone: tel,
            produtos: produtosStr,
            valor: valorTotalGeral,
            valorObs: valorObs,
            negociadoras: negociadoras,
            qTickets: qTickets, 
            qTablets: qTablets,
            qNitro: qNitro,
            tipo: tipo,
            // NOVO: Informação de quem registrou
            registradoPor: currentUser.displayName || 'Usuário Desconhecido'
        };
        
        try {
            if (vendaEmEdicaoId) {
                // Edição: Atualiza o nó existente
                const saleRef = ref(db, `vendas/${vendaEmEdicaoId}`);
                await set(saleRef, newSaleData);
                showToast("Edição salva no histórico global!", "success");
                
                vendaEmEdicaoId = null;
                els.registerBtn.textContent = 'Registrar Venda';
            } else {
                // Nova venda: Usa 'push' para criar um ID único
                const vendasRef = ref(db, 'vendas');
                await push(vendasRef, newSaleData);
                showToast(`Venda registrada para ${nome} no histórico global!`, "success");
            }
            
            clearAllFields();
            // A renderização é automática via setupGlobalHistoryListener
            
        } catch (error) {
            console.error("Erro ao registrar/atualizar venda:", error);
            showToast("Erro ao comunicar com o banco de dados.", "error");
        }
    }
    
    // Funções de edição e validação (código original)

    function editVenda(id) {
        if (!currentUser) {
            showToast("Você deve estar logado para editar vendas.", "error");
            return;
        }
        
        const venda = vendas.find(v => v.id === id);
        if (!venda) return;
        
        els.nomeCliente.value = venda.cliente;
        const [tipoOrg, nomeOrg] = venda.organizacao.split(' - '); 
        els.organizacao.value = (nomeOrg && nomeOrg !== 'N/A') ? nomeOrg : ''; 
        els.organizacaoTipo.value = (tipoOrg && tipoOrg !== 'N/A') ? tipoOrg : 'CNPJ'; 
        
        let telParaEdicao = venda.telefone.replace(/\D/g, "");
        if (telParaEdicao.startsWith('055')) {
            telParaEdicao = telParaEdicao.substring(3);
        }
        
        const ddd = telParaEdicao.substring(0, 3);
        const num = telParaEdicao.substring(3, 6);
        els.telefone.value = `(055) ${ddd}${num ? '-' + num : ''}`.trim(); 
        
        els.negociadoras.value = (venda.negociadoras && venda.negociadoras.toLowerCase() !== 'n/a') ? venda.negociadoras : '';
        
        let obsPura = venda.valorObs || 'N/A';
        let tipoEncontrado = 'limpo';
        
        for (const [tipoKey, desc] of Object.entries(valorDescricao)) {
            if (obsPura.includes(desc)) {
                tipoEncontrado = tipoKey;
                obsPura = obsPura.replace(desc, '').replace(/\|/g, '').trim();
                break;
            }
        }
        
        els.tipoValor.value = tipoEncontrado; 
        els.vendaValorObs.value = (obsPura && obsPura.toLowerCase() !== 'n/a') ? obsPura : ''; 
        
        
        els.qtyTickets.value = venda.qTickets || '';
        els.qtyTablets.value = venda.qTablets || '';
        els.qtyNitro.value = venda.qNitro || '';
        
        
        els.dataVenda.value = venda.dataHora;
        
        vendaEmEdicaoId = id;
        
        toggleView(false); 
        
        els.registerBtn.textContent = 'Salvar Edição';
        showToast(`Editando venda de ${venda.cliente}`, "default", 2000);
        
        renderResults(calculateTotals()); 
    }
    // EXPOE AO ESCOPO GLOBAL PARA O ONCLICK FUNCIONAR
    window.editVenda = editVenda;


    function clearValidationErrors() {
        const requiredFields = [els.nomeCliente, els.organizacao, els.telefone, els.negociadoras];
        requiredFields.forEach(field => {
            field.classList.remove('input-invalido');
        });
    }

    function validateFields() {
        clearValidationErrors(); 
        let isValid = true;
        
        // Campos sempre obrigatórios: Nome, Telefone, Negociadoras
        let requiredFields = [els.nomeCliente, els.telefone, els.negociadoras];
        
        // NOVO: Adiciona 'organizacao' se o tipo selecionado for CNPJ
        if (els.organizacaoTipo.value === 'CNPJ') {
            requiredFields.push(els.organizacao);
        }

        requiredFields.forEach(field => {
            // Verifica se o campo está vazio, ou 'N/A', ou apenas o prefixo do telefone
            if (field.value.trim() === '' || field.value.trim().toLowerCase() === 'n/a' || field.value.trim() === '(055)') {
                field.classList.add('input-invalido');
                isValid = false;
            }
        });
        
        if (!isValid) {
            showToast("Preencha todos os campos obrigatórios em vermelho.", "error");
        }
        
        return isValid;
    }
    
    // Função de renderização modificada para usar dados do Firebase
    function renderHistorico(searchTerm = '') {
        const tbody = els.salesHistory;
        tbody.innerHTML = '';
        
        const termo = searchTerm.toLowerCase().trim();
        
        const vendasFiltradas = vendas.filter(venda => {
            if (!termo) return true; 
            
            const content = `${venda.cliente} ${venda.organizacao} ${venda.telefone} ${venda.produtos} ${venda.valor} ${venda.valorObs} ${venda.negociadoras} ${venda.registradoPor || ''}`.toLowerCase();
            
            return content.includes(termo);
        });

        if (vendasFiltradas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">Nenhum registro encontrado.</td></tr>';
            return;
        }

        vendasFiltradas.forEach(data => {
            const [dataStr, horaStr] = data.dataHora.split(' ');
            const valorBase = `R$ ${numberWithCommas(data.valor)}`;
            
            const valorComObs = (data.valorObs && data.valorObs.toLowerCase() !== 'n/a') ? 
                `<span>${valorBase}</span><span class="valor-obs-text" style="color: var(--cor-principal);">(${data.valorObs})</span>` :
                `<span>${valorBase}</span>`;
                
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding: 0;">
                    <span class="history-datetime-line">${dataStr}</span>
                    <span class="history-datetime-line">${horaStr}</span>
                </td>
                <td>${data.cliente}</td>
                <td>${data.organizacao}</td> 
                <td>${data.telefone}</td>
                <td>${data.produtos}</td>
                <td class="valor-total-cell">${valorComObs}</td>
                <td>${data.negociadoras}</td>
                <td>${data.registradoPor || 'N/A'}</td> <td class="history-actions-cell"> 
                    <button class="muted action-btn" onclick="copyDiscordFromHistory(this)">Discord</button>
                    <button class="muted action-btn" onclick="editVenda('${data.id}')" style="background-color: ${document.body.classList.contains('dark') ? '#996600' : '#ff9900'};">Editar</button>
                    <button class="danger action-btn" onclick="deleteVenda('${data.id}')">Excluir</button>
                </td>
            `;
            
            tr.saleData = data; 
            
            tbody.appendChild(tr);
        });
    }
    
    // Função para copiar do histórico 
    window.copyDiscordFromHistory = function(buttonElement) { // Tornada global para o onclick
        const tr = buttonElement.closest('tr');
        const data = tr.saleData;
        
        if (!data) return; 
        
        const nome = data.cliente;
        const org = (data.organizacao && data.organizacao.toLowerCase() !== 'n/a') ? data.organizacao : '';
        const tel = (data.telefone && data.telefone.toLowerCase() !== 'n/a') ? data.telefone : '';
        const negociadoras = (data.negociadoras && data.negociadoras.toLowerCase() !== 'n/a') ? data.negociadoras : '';
        const registradoPor = data.registradoPor || 'N/A'; // NOVO: Campo
        let valorObs = (data.valorObs && data.valorObs.toLowerCase() !== 'n/a') ? data.valorObs : '';
        
        const valorBase = `R$ ${numberWithCommas(data.valor)}`;
        const valorTotalFormatado = valorObs ? `${valorBase} (${valorObs})` : valorBase;

        const lines = [
            `Nome: ${nome}`,
            `Data: ${data.dataHora}`, 
            org ? `Organização: ${org}` : null,
            tel ? `Telefone: ${tel}` : null,
            `Produto (Unidade): ${data.produtos}`,
            `Venda Valor: ${valorTotalFormatado}`,
            negociadoras ? `Negociadoras: ${negociadoras}` : null,
            `Registrado por: ${registradoPor}`
        ].filter(line => line !== null); 

        const discordOutput = `\`\`\`\n${lines.join('\n')}\n\`\`\``.trim();

        navigator.clipboard.writeText(discordOutput).then(() => {
            showToast("Valor do Histórico copiado para o Discord!", "success");
        }).catch(err => {
            console.error('Erro ao copiar: ', err);
            showToast("Erro ao copiar. Seu navegador pode não suportar a cópia automática.", "error");
        });
    }
    
    // Função para copiar da calculadora
    function copyDiscordFromCalc() {
        if (!currentUser) {
            showToast("Você precisa estar logado para copiar para o Discord.", "error");
            return;
        }

        const data = calculateTotals();
        
        if (data.valorTotalGeral <= 0 && data.qTickets === 0 && data.qTablets === 0 && data.qNitro === 0) {
            showToast("Calcule um valor válido antes de copiar.", "error");
            return;
        }

        const nome = els.nomeCliente.value.trim() || 'N/A';
        const tipoOrg = els.organizacaoTipo.value; 
        const org = els.organizacao.value.trim() || 'N/A';
        const tel = els.telefone.value.trim() || 'N/A';
        const negociadoras = els.negociadoras.value.trim() || 'N/A';
        let valorObs = els.vendaValorObs.value.trim() || 'N/A';
        
        const produtos = [];
        if(data.qTablets>0) produtos.push(`Tablet (${data.qTablets})`);
        if(data.qNitro>0) produtos.push(`Nitros (${data.qNitro})`);
        if(data.qTickets>0) produtos.push(`Tickets (${data.qTickets})`);
        const produtosStr = produtos.length > 0 ? produtos.join(', ') : 'Nenhum Produto';
        
        let descTipo = '';
        if (data.tipo !== 'limpo' && data.tipo !== 'limpo_alianca') {
            descTipo = valorDescricao[data.tipo] || '';
        }
        
        if (descTipo && valorObs.toLowerCase() !== 'n/a') {
            valorObs = `${descTipo} | ${valorObs}`;
        } else if (descTipo) {
            valorObs = descTipo;
        } else if (valorObs.toLowerCase() === 'n/a') {
            valorObs = 'N/A';
        }

        
        const valorBase = `R$ ${numberWithCommas(data.valorTotalGeral)}`;
        const valorTotalFormatado = (valorObs && valorObs.toLowerCase() !== 'n/a') ? `${valorBase} (${valorObs})` : valorBase;

        const dataHoraFormatada = els.dataVenda.value; 

        const orgStr = (org.toLowerCase() !== 'n/a') ? `${tipoOrg} - ${org}` : '';
        const telStr = (tel.toLowerCase() !== 'n/a') ? tel : '';
        const negociadorasStr = (negociadoras.toLowerCase() !== 'n/a') ? negociadoras : '';
        
        const lines = [
            `Nome: ${nome}`,
            `Data: ${dataHoraFormatada}`, 
            orgStr ? `Organização: ${orgStr}` : null,
            telStr ? `Telefone: ${telStr}` : null,
            `Produto (Unidade): ${produtosStr}`,
            `Venda Valor: ${valorTotalFormatado}`,
            negociadorasStr ? `Negociadoras: ${negociadorasStr}` : null,
            `Calculado por: ${currentUser ? currentUser.displayName : 'Anônimo'}` // NOVO: Usuário logado
        ].filter(line => line !== null); 

        const discordOutput = `\`\`\`\n${lines.join('\n')}\n\`\`\``.trim();

        navigator.clipboard.writeText(discordOutput).then(() => {
            showToast("Cálculo copiado para o Discord!", "success");
        }).catch(err => {
            console.error('Erro ao copiar: ', err);
            showToast("Erro ao copiar.", "error");
        });
    }


    function clearAllFields() {
        els.qtyTickets.value = '';
        els.qtyTablets.value = '';
        els.qtyNitro.value = '';
        els.tipoValor.value = 'limpo';
        
        els.nomeCliente.value = '';
        els.organizacaoTipo.value = 'CNPJ';
        els.organizacao.value = '';
        els.telefone.value = ''; 
        els.negociadoras.value = '';
        els.vendaValorObs.value = '';
        
        els.results.style.display='none';
        updateDateTime(); 
        
        clearValidationErrors(); 
        clearTour();
    }
    
    // --- Lógica de Enter para Avançar ---
    const allInputs = [
        els.nomeCliente, els.organizacao, els.organizacaoTipo, 
        els.telefone, els.negociadoras, els.vendaValorObs,
        els.qtyTickets, els.qtyTablets, els.qtyNitro, els.tipoValor
    ].filter(el => el);

    const inputMap = new Map(allInputs.map((input, index) => [input.id, index]));

    function handleEnterKey(e, input) {
        if (e.key !== 'Enter') return;
        
        e.preventDefault();
        
        if (currentTourStep > 0 && currentTourStep <= tourSteps.length) {
            const targetStepIndex = currentTourStep - 1; 
            
            if (tourSteps[targetStepIndex] && tourSteps[targetStepIndex].target === input) {
                nextStep();
            } else {
                advanceInputFocus(input);
            }
            return;
        }
        
        advanceInputFocus(input);
    }
    
    function advanceInputFocus(input) {
        const currentIndex = inputMap.get(input.id);
        if (currentIndex !== undefined) {
            let nextIndex = currentIndex + 1;
            let next = allInputs[nextIndex];
            
            while (next && next.readOnly) {
                nextIndex++;
                next = allInputs[nextIndex];
            }

            if (next) {
                next.focus();
            } else {
                els.calcBtn.focus();
            }
        }
    }


    allInputs.forEach(input => {
        input.addEventListener('keydown', e => handleEnterKey(e, input));
    });
    // --- FIM Lógica de Enter para Avançar ---
    
    // Função para atualizar logos conforme o tema
    function updateThemeLogo() {
        const isDark = document.body.classList.contains('dark');
        
        if (els.appLogo) {
            els.appLogo.src = isDark ? logoDarkModeSrc : logoLightModeSrc; 
        }
        
        const welcomeLogo = document.getElementById('welcomeLogo');
        if (welcomeLogo) {
            welcomeLogo.src = welcomeLogoSrc;
        }

        const historyImg = document.getElementById('historyImg');
        if (historyImg) {
            historyImg.src = historyBackgroundSrc;
        }
    }

    // --- LÓGICA DA TELA DE BOAS-VINDAS E AUTENTICAÇÃO ---
    function checkWelcomeScreen() {
        els.welcomeScreen.classList.add('show');
        els.mainCard.style.display = 'none';
        els.authScreen.style.display = 'none';
    }
    
    // Event listener para o botão de entrada
    els.enterBtn.addEventListener('click', () => {
        els.welcomeScreen.classList.add('hidden');
        
        setTimeout(() => {
            els.welcomeScreen.classList.remove('show');
            els.welcomeScreen.style.display = 'none';
            // Se o usuário não estiver logado, mostra a tela de autenticação
            if (!currentUser) {
                 els.authScreen.style.display = 'block';
            }
        }, 500); 
    });
    // --- FIM LÓGICA DA TELA DE BOAS-VINDAS ---


    // Event Listeners

    els.calcBtn.addEventListener('click',()=>renderResults(calculateTotals()));
    els.registerBtn.addEventListener('click',registerSale); 
    
    // NOVO: Listeners de Autenticação
    els.loginBtn.addEventListener('click', handleLogin);
    els.registerUserBtn.addEventListener('click', handleCadastro);
    els.logoutBtn.addEventListener('click', handleLogout);
    
    els.resetBtn.addEventListener('click', clearAllFields);
    clearAllFields(); 
    
    const validationFields = [els.nomeCliente, els.organizacao, els.telefone, els.negociadoras];
    validationFields.forEach(field => {
        field.addEventListener('input', () => {
            if (field.value.trim() !== '' && field.value.trim().toLowerCase() !== 'n/a' && field.value.trim() !== '(055)') {
                field.classList.remove('input-invalido');
            }
        });
    });

    els.telefone.addEventListener('input', formatarTelefone);
    
    els.nomeCliente.addEventListener('input', capitalizeWords);
    els.organizacao.addEventListener('input', capitalizeWords);
    els.negociadoras.addEventListener('input', capitalizeWords);
    els.vendaValorObs.addEventListener('input', capitalizeWords);
    
    els.organizacao.addEventListener('input', checkSingleSuggestion);
    els.organizacao.addEventListener('keydown', handleTabForSuggestion);

    els.discordBtnCalc.addEventListener('click', copyDiscordFromCalc);

    if (els.filtroHistorico) {
        els.filtroHistorico.addEventListener('input', () => {
            renderHistorico(els.filtroHistorico.value);
        });
    }
    
    els.tutorialBtn.addEventListener('click', () => {
        startTour(0); 
    });

    els.csvBtn.addEventListener('click',()=>{
      const out=calculateTotals();
      const rows=[['Material/Produto','Quantidade ou Valor']];
      for(const[k,v]of Object.entries(out.totals))rows.push([k,v]);
      for(const[k,v]of Object.entries(out.valoresTotais))rows.push([k,`R$ ${v}`]);
      rows.push(['Valor Total Geral',`R$ ${out.valorTotalGeral}`]);
      
      // Adicionando dados da venda ao CSV
      rows.push(['','']);
      rows.push(['**DADOS DA VENDA**','']);
      rows.push(['Nome do Cliente', els.nomeCliente.value.trim() || 'N/A']);
      rows.push(['Organização', `${els.organizacaoTipo.value} - ${els.organizacao.value.trim() || 'N/A'}`]);
      rows.push(['Telefone', els.telefone.value.trim() || 'N/A']);
      rows.push(['Negociadoras', els.negociadoras.value.trim() || 'N/A']);
      rows.push(['Obs. Venda', els.vendaValorObs.value.trim() || 'N/A']);
      rows.push(['Registrado Por', currentUser ? currentUser.displayName : 'Anônimo']);


      const csv=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');a.href=url;a.download='materiais_valores.csv';a.click();URL.revokeObjectURL(url);
    });

    // MODIFICADO: Limpar Histórico usa o 'remove' do Firebase
    els.clearHistoryBtn.addEventListener('click', async () => {
      if (!currentUser) {
            showToast("Você deve estar logado para limpar o histórico.", "error");
            return;
      }
      if(confirm('ATENÇÃO: Isso apagará TODO o histórico para TODOS os usuários. Tem certeza?')) {
        try {
            const vendasRef = ref(db, 'vendas');
            await remove(vendasRef);
            showToast("Histórico de vendas completamente apagado para todos!", "error");
            // A renderização é automática via setupGlobalHistoryListener (vendas = [])
        } catch (error) {
            console.error("Erro ao apagar todo o histórico:", error);
            showToast("Erro ao apagar todo o histórico.", "error");
        }
      }
    });

    els.themeBtn.addEventListener('click',()=>{
      document.body.classList.toggle('dark');
      document.body.classList.toggle('light');
      els.themeBtn.textContent=document.body.classList.contains('dark')?'☀️ Modo Claro':'🌙 Modo Noturno';
      
      updateThemeLogo(); 
    });
    
    
    els.toggleHistoryBtn.addEventListener('click', () => toggleView(true));
    
    els.toggleCalcBtn.addEventListener('click', () => {
        if (vendaEmEdicaoId) { 
            vendaEmEdicaoId = null;
            els.registerBtn.textContent = 'Registrar Venda';
            clearAllFields();
            showToast("Edição pendente cancelada.", "error", 2000);
        }
        toggleView(false);
    });
    
    els.logoLink.addEventListener('click', (e) => {
        e.preventDefault(); 

        if (vendaEmEdicaoId) {
            vendaEmEdicaoId = null;
            els.registerBtn.textContent = 'Registrar Venda';
            clearAllFields();
            showToast("Edição pendente cancelada.", "error", 2000);
        }
        
        toggleView(false); 
        clearTour(); 
    });
    
    // --- Chamadas Iniciais e Lógica de Estado do Firebase ---
    
    // Escuta o estado de autenticação (logado/deslogado)
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // Usuário logado: garante que o estado é 'logado'
             currentUser = user; 
             // Se o mainCard não estiver visível (i.e., vindo do login/cadastro), exibe.
             if (els.mainCard.style.display === 'none') {
                handleLoginSucess(user);
             }
        } else {
            // Usuário deslogado: garante que o estado é 'deslogado'
            currentUser = null;
            if (els.welcomeScreen.classList.contains('hidden') && els.welcomeScreen.style.display === 'none') {
                els.authScreen.style.display = 'block';
                els.mainCard.style.display = 'none';
                els.historyCard.style.display = 'none';
            }
        }
    });
    
    updateThemeLogo();
    checkWelcomeScreen(); // Chamada inicial que mostra a tela de boas-vindas
  </script>
</body>

</html>
