<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <link rel="icon" type="image/png" href="logo-dark.png">
  
  <title>Hells Angels</title>
  <style>
    :root {
      --cor-fundo: #fff0f6;
      --cor-texto: #4a0033;
      --cor-principal: #e60073;
      --cor-card: #ffffff;
      --cor-borda: #ffb3d9;
      --cor-btn-primario: #e60073;
      --cor-btn-texto: #fff;
      --cor-btn-secundario: #ffd6eb;
      --cor-btn-secundario-texto: #4a0033;
      --cor-erro: #cc0000;
      /* NOVO: Cor para o brilho pulsante */
      --cor-glow-pulsante: rgba(230, 0, 115, 0.8); /* Cor Principal com opacidade */
    }

    body.dark {
      --cor-fundo: #1a000d; 
      --cor-texto: #ffccf0; 
      --cor-principal: #ff0080; 
      --cor-card: #2c001a; 
      --cor-borda: #e60073; 
      --cor-btn-primario: #ff0080; 
      --cor-btn-texto: #fff;
      --cor-btn-secundario: #4d002a; 
      --cor-btn-secundario-texto: #ffccf0; 
      /* NOVO: Cor para o brilho pulsante no modo escuro */
      --cor-glow-pulsante: rgba(255, 0, 128, 0.6); /* Cor Principal Escura com opacidade */
    }
    
    body.dark input[type=number], body.dark input[type=text], body.dark select {
      background: #33001f;
      color: var(--cor-texto);
      border: 1px solid var(--cor-borda);
    }
    
    /* --- ESTILO PARA INPUT DATALIST (Foco Rosa/Roxo) --- */
    input[list]:focus, input[list]:hover {
        border-color: var(--cor-principal) !important; 
        box-shadow: 0 0 5px rgba(230, 0, 115, 0.4); 
    }
    
    /* --- NOVO ESTILO PARA DATALIST (Sugest√µes de Organiza√ß√£o) --- */
    input[list] {
        position: relative;
        z-index: 1; 
    }
    
    input[list]::-webkit-calendar-picker-indicator {
        display: none;
    }
    /* --- FIM NOVO ESTILO PARA DATALIST --- */
    
    /* --- NOVO: Estilo para a dica de sugest√£o da Organiza√ß√£o --- */
    .suggestion-tip {
        font-size: 11px;
        color: var(--cor-principal); /* Usa a cor principal para destaque */
        margin-top: 4px;
        margin-bottom: 0;
        font-weight: 500;
        opacity: 0.8;
    }
    /* --- FIM NOVO: Estilo para a dica de sugest√£o da Organiza√ß√£o --- */
    
    /* --- ESTILOS TOUR --- */
    .tour-tooltip {
      position: absolute;
      background: var(--cor-principal);
      color: var(--cor-btn-texto);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      max-width: 300px;
      text-align: left;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 10002;
    }

    .tour-tooltip.active {
      opacity: 1;
      transform: translateY(0);
    }

    .tour-tooltip h4 {
        margin: 0 0 5px;
        font-size: 16px;
        color: var(--cor-btn-texto);
    }
    .tour-tooltip p {
        margin: 0;
        font-size: 14px;
        margin-bottom: 10px;
    }
    
    .tour-tooltip button {
        background: var(--cor-btn-secundario);
        color: var(--cor-btn-secundario-texto);
        padding: 6px 10px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        margin-right: 8px;
    }
    
    .tour-highlight {
      box-shadow: 0 0 0 3px rgba(230,0,115,0.6), 0 0 10px rgba(230,0,115,0.5);
      position: relative;
      z-index: 10001;
    }
    /* --- FIM ESTILOS TOUR --- */
    
    /* --- ESTILO PARA CAMPO INV√ÅLIDO --- */
    input.input-invalido, select.input-invalido {
        border: 2px solid var(--cor-erro) !important;
        box-shadow: 0 0 4px var(--cor-erro);
    }
    /* --- FIM ESTILO PARA CAMPO INV√ÅLIDO --- */

    
    /* Container para a logo */
    #logoLink {
        position: fixed;
        top: 16px; 
        left: 16px; 
        width: auto; 
        max-height: 80px; 
        cursor: pointer;
        z-index: 9998; 
    }
    
    /* Ajuste na logo superior */
    .app-logo {
      max-height: 80px; 
      width: auto;
      transition: opacity 0.3s ease, filter 0.3s ease; /* Adicionado filter para a transi√ß√£o do hover */
      display: block; 
    }
    
    /* NOVO: Efeito de ilumina√ß√£o ao passar o mouse na Logo (na calculadora) */
    #appLogo:hover {
        /* Brilho da logo ao passar o mouse */
        filter: drop-shadow(0 0 8px var(--cor-principal)) drop-shadow(0 0 15px var(--cor-glow-pulsante));
        opacity: 0.9;
    }

    
    /* --- Estilo para a imagem na tela de boas-vindas --- */
    #welcomeLogo {
      max-width: 80%;
      max-height: 120px; 
      margin-bottom: 25px;
      display: block;
      /* N√ÉO ADICIONAR EFEITO DE HOVER AQUI */
    }
    
    #welcomeScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--cor-card);
      z-index: 10000; 
      display: none; 
      flex-direction: column;
      justify-content: center; 
      align-items: center;
      text-align: center;
      transition: opacity 0.5s ease;
      padding: 20px; 
      box-sizing: border-box; 
    }
    
    #welcomeScreen.show {
        display: flex; 
    }

    #welcomeScreen.hidden {
      opacity: 0;
      pointer-events: none; 
    }
    
    #welcomeScreen h2 {
      font-size: 36px;
      margin-top: 10px; 
      margin-bottom: 20px;
      color: var(--cor-principal);
    }
    
    #welcomeScreen button {
      padding: 12px 24px;
      font-size: 18px;
      border-radius: 10px;
      margin-top: 10px;
    }


    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 960px;
      margin: 24px auto;
      padding: 20px;
      background: var(--cor-fundo);
      color: var(--cor-texto);
      transition: background 0.25s ease, color 0.25s ease;
    }
    
    /* Garante que o conte√∫do principal comece escondido e s√≥ apare√ßa se JS/Welcome Screen n√£o funcionar */
    #mainCard {
        display: block; 
    }

    h1 {
      margin: 0 0 12px;
      font-size: 24px;
      font-weight: 700;
      color: var(--cor-principal);
      text-align: center;
    }

    h2 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--cor-principal);
    }
    
    h3 {
        color: var(--cor-principal); 
        font-weight:600; 
        margin-top: 16px;
    }

    .card {
      background: var(--cor-card);
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 1px solid var(--cor-borda);
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin: 10px 0 6px;
      font-weight: 600;
      color: var(--cor-principal);
    }

    input[type=number], input[type=text], select {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid var(--cor-borda);
      background: #fff;
      color: var(--cor-texto);
      font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    
    input[type=number] {
        width: 140px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      margin-top: 12px;
    }
    
    .grid-venda {
        grid-template-columns: 1fr 1fr;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 14px;
    }

    th, td {
      padding: 6px; /* Reduzido o padding para caber mais na tela do celular */
      border-bottom: 1px solid var(--cor-borda);
      text-align: left;
    }

    th {
      background: var(--cor-btn-secundario);
      color: var(--cor-btn-secundario-texto);
      font-weight: 600;
    }
    
    
/* --- NOVO ESTILO PARA RESPONSIVIDADE DA TABELA --- */
.history-table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    width: 100%;
    margin-top: 8px;
}

/* Garante que o container interno n√£o atrapalhe a rolagem */
#historyBackground {
    overflow: hidden;
}

/* Mant√©m a tabela com comportamento de tabela e largura controlada */
#historyCard table {
    width: 100%;
    display: table;
    border-collapse: collapse;
    table-layout: fixed; /* ajuda a manter colunas alinhadas */
    min-width: 900px; /* for√ßa scroll em telas pequenas mantendo alinhamento */
}

/* Estilo base para c√©lulas */
#historyCard th, #historyCard td {
    padding: 8px 10px;
    vertical-align: middle;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 13px;
}

/* Ajuste para a linha de data/hora (duas linhas dentro da mesma c√©lula) */
.history-datetime-line {
    display: block;
    line-height: 1.1;
    font-size: 12px;
}

/* Faz com que valores longos quebrem visualmente melhor em c√©lulas menores quando necess√°rio */
@media (max-width: 700px) {
    #historyCard th, #historyCard td {
        font-size: 12px;
    }
    #historyCard th:nth-child(5), #historyCard td:nth-child(5) { width: 320px; }
}
/* --- FIM NOVO ESTILO PARA RESPONSIVIDADE DA TABELA --- */



    .actions {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    button {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: opacity 0.2s ease, box-shadow 0.3s ease; /* Adicionado box-shadow para transi√ß√£o do glow */
    }
    
    button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        animation: none !important;
    }

    button:hover { opacity: 0.85; }
    
    /* NOVO: Efeito de brilho pulsante para o bot√£o principal (Calcular/Registrar) */
    .primary, .success {
        animation: pulse-glow 2s infinite ease-in-out;
    }
    
    /* NOVO: Keyframes para o brilho pulsante */
    @keyframes pulse-glow {
        0% {
            box-shadow: 0 0 0 rgba(0, 0, 0, 0); 
        }
        50% {
            box-shadow: 0 0 10px var(--cor-glow-pulsante), 0 0 20px var(--cor-glow-pulsante); 
        }
        100% {
            box-shadow: 0 0 0 rgba(0, 0, 0, 0); 
        }
    }

    .primary { background: var(--cor-btn-primario); color: var(--cor-btn-texto); }
    .muted { background: var(--cor-btn-secundario); color: var(--cor-btn-secundario-texto); }
    .success { background: #00b33c; color: #fff; }
    .danger { background: var(--cor-erro); color: #fff; } /* Novo: Bot√£o de Perigo */

    /* Container para agrupar e posicionar bot√µes (Modo Noturno e Tutorial) */
    .top-right-controls {
        position: fixed;
        top: 16px;
        right: 16px;
        display: flex;
        gap: 10px;
        z-index: 9999;
    }

    /* Estilo base para bot√µes de controle fixos */
    .control-btn {
        padding: 10px 14px;
        border-radius: 10px;
        background: var(--cor-btn-primario);
        color: var(--cor-btn-texto);
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        border: none;
        transition: opacity 0.2s ease;
        /* ANIMA√á√ÉO pulse-glow REMOVIDA DAQUI */
    }
    .control-btn:hover {
        opacity: 0.85;
    }
    
    /* --- Estilo para o Fundo do Hist√≥rico --- */
    #historyBackground {
      /* ALTERA√á√ÉO: Fundo semi-transparente (70%) */
      background: rgba(255, 255, 255, 0.7); 
      position: relative; 
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 1px solid var(--cor-borda);
      margin-bottom: 20px;
      min-height: 400px; 
      overflow: hidden;
    }
    
    #historyBackground img {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: auto;
      opacity: 0.3; /* ALTERA√á√ÉO: Aumentado para maior visibilidade */ 
      z-index: 1; 
      object-fit: contain; 
    }
    
    #historyBackground > * {
      position: relative; 
      z-index: 2;
    }
    
    #historyCard table {
        font-size: 12px;
    }
    
    /* --- CORRE√á√ÉO DE ALINHAMENTO DAS C√âLULAS (Principal Altera√ß√£o) --- */
    /* Garante que o conte√∫do fique no topo para alinhar a borda inferior */
    
#historyCard th, #historyCard td {
    padding: 8px 6px;
    text-align: center;
    vertical-align: middle; /* Centraliza verticalmente */
    white-space: nowrap;    /* Evita quebras desnecess√°rias */
}

/* Corrige o bloco de data/hora */
#historyCard tr td:first-child {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    line-height: 1.2;
    padding: 4px 0;
}

.history-datetime-line {
    display: block;
    font-size: 12px;
}

    
    /* Estilo para cada linha do texto dentro da c√©lula de Data/Hora */
    .history-datetime-line {
        display: block;
        line-height: 1.2; 
        padding: 6px 0 0 6px; /* Adiciona o padding de volta (topo e esquerda) */
    }
    
    /* Reduz o espa√ßamento vertical para compactar o texto na c√©lula de Valor Total (que tem quebra de linha) */
    
.valor-total-cell {
    display: flex;
    flex-direction: column;
    align-items: center;      /* Centraliza horizontalmente */
    justify-content: center;  /* Centraliza verticalmente */
    padding: 4px 0;
    line-height: 1.3;
    text-align: center;
}

.valor-total-cell span {
    display: block;
}

.valor-obs-text {
    font-size: 11px;
    color: var(--cor-principal);
    margin-top: 2px; /* Pequeno espa√ßamento entre o valor e a observa√ß√£o */
}

    
    /* --- FIM CORRE√á√ÉO DE ALINHAMENTO --- */
    
    
    /* Estilo para colocar os bot√µes do hist√≥rico na mesma linha (Responsivo) */
    .history-actions-cell {
        display: flex;
        gap: 5px; /* Espa√ßamento entre os bot√µes */
        flex-wrap: nowrap; /* Garante que fiquem na mesma linha */
        padding-top: 4px; /* Ajuste para o padding das outras c√©lulas */
    }
    
    .history-actions-cell button {
        padding: 4px 8px;
        font-size: 11px;
        margin-top: 2px; /* Pequeno ajuste de margem */
        border-radius: 4px;
        white-space: nowrap; /* Impede a quebra de linha dos bot√µes */
    }

    /* --- Estilos para Notifica√ß√£o Toast --- */
    #toast-container {
        position: fixed;
        bottom: 20px; 
        right: 20px; 
        z-index: 10005; 
        display: flex;
        flex-direction: column-reverse; 
        gap: 10px; 
        align-items: flex-end; 
    }

    .toast {
        background-color: var(--cor-principal); 
        color: var(--cor-btn-texto);
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        opacity: 0;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        transform: translateY(20px); 
        max-width: 300px;
        min-width: 150px;
        text-align: center;
    }

    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }
    
    .toast.success {
        background-color: #00b33c; 
    }

    .toast.error {
        background-color: var(--cor-erro); 
    }
    
    .action-btn {
        padding: 4px 8px;
        font-size: 12px;
        margin-right: 0px; 
        border-radius: 4px;
    }
    
    /* Otimiza√ß√£o para telas muito pequenas */
    @media (max-width: 500px) {
        body {
            padding: 10px;
            margin: 10px auto;
        }
        .top-right-controls {
            top: 10px;
            right: 10px;
        }
        .control-btn {
            padding: 8px 10px;
            font-size: 12px;
        }
        .grid {
            grid-template-columns: 1fr;
        }
        .grid-venda {
            grid-template-columns: 1fr;
        }
    }
    /* --- FIM Estilos para Notifica√ß√£o Toast --- */
  
/* --- ESTILO FINAL DA TABELA DE HIST√ìRICO --- */
.history-table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    width: 100%;
    margin-top: 8px;
}

#historyCard table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    min-width: 900px;
    background: transparent; 
}

#historyCard th, #historyCard td {
    padding: 6px 8px; /* Aumentado de 4px 6px */
    text-align: center;
    vertical-align: middle;
    white-space: nowrap;
    font-size: 14px; /* Aumentado de 13px */
    border-bottom: 1px solid var(--cor-borda);
}

/* NOVO: Fundo para as c√©lulas de dados para garantir a legibilidade */
#historyCard td {
    background: var(--cor-card); 
    opacity: 0.95; /* Leve transpar√™ncia para manter o efeito do fundo */
}

body.dark #historyCard td {
    background: var(--cor-card); /* Cor do card escuro */
    opacity: 0.95;
}


/* Alinhamento individual por coluna - larguras ajustadas */
#historyCard th:nth-child(1), #historyCard td:nth-child(1) { width: 100px; }   /* Data/Hora - Aumentado */
#historyCard th:nth-child(2), #historyCard td:nth-child(2) { width: 140px; }  /* Cliente - Aumentado */
#historyCard th:nth-child(3), #historyCard td:nth-child(3) { width: 160px; }  /* Organiza√ß√£o */
#historyCard th:nth-child(4), #historyCard td:nth-child(4) { width: 110px; }  /* Telefone */
#historyCard th:nth-child(5), #historyCard td:nth-child(5) { width: 280px; }  /* Produtos - Aumentado */
#historyCard th:nth-child(6), #historyCard td:nth-child(6) { width: 150px; }  /* Valor - Aumentado */
#historyCard th:nth-child(7), #historyCard td:nth-child(7) { width: 130px; }  /* Negociadoras */
#historyCard th:nth-child(8), #historyCard td:nth-child(8) { width: 150px; }  /* A√ß√µes */

/* Data e hora */
.history-datetime-line {
    display: block;
    line-height: 1.2; /* Aumentado */
    font-size: 13px; /* Aumentado */
}

/* Valor Total - tornando o valor em negrito */
.valor-total-cell span:first-child {
    font-weight: 700; /* Negrito */
}

.valor-obs-text {
    font-size: 12px; /* Aumentado */
    color: var(--cor-principal);
}

/* Bot√µes de a√ß√µes */
.history-actions-cell {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}

.history-actions-cell button {
    padding: 3px 6px;
    font-size: 11px;
    border-radius: 4px;
    white-space: nowrap;
}

/* Aumenta altura total da linha */
#historyCard tr {
    height: 40px;
}

/* NOVO: Estilo para o cabe√ßalho TH */
#historyCard th {
    background: var(--cor-principal); /* Usa a cor principal para o cabe√ßalho */
    color: var(--cor-btn-texto);     /* Texto branco */
}

/* NOVO: Fundo semi-transparente para modo escuro */
body.dark #historyBackground {
  /* Cor escura do card #2c001a (que √© 44, 0, 26 em RGB) com 70% de opacidade */
  background: rgba(44, 0, 26, 0.7); 
}
/* --- FIM DO ESTILO FINAL DA TABELA DE HIST√ìRICO --- */

/* --- NOVO ESTILO PARA TELA DE LOGIN (#authScreen) --- */
#authScreen {
    /* Melhorar o visual do card de login */
    padding: 25px; /* Mais padding */
    border-radius: 16px; /* Mais arredondado */
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); /* Sombra mais profunda */
}

/* T√≠tulo com divisor */
#authScreen h2 {
    text-align: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--cor-borda); /* Linha divis√≥ria */
    font-size: 26px; /* Maior */
}

/* Melhorar inputs do login */
#authScreen input[type=text], 
#authScreen input[type=password] {
    padding: 12px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid var(--cor-borda);
    /* Transi√ß√£o de foco mais suave */
    transition: all 0.3s ease;
}

#authScreen input[type=text]:focus, 
#authScreen input[type=password]:focus {
    border-color: var(--cor-principal) !important;
    box-shadow: 0 0 10px rgba(230, 0, 115, 0.5); /* Brilho mais intenso */
}

/* Fazer bot√µes ocuparem a largura total na tela de login */
#authScreen .actions {
    margin-top: 20px;
    display: flex;
    flex-direction: column; /* Pilha de bot√µes */
    gap: 10px;
}

#authScreen .actions button {
    width: 100%;
    padding: 12px;
    font-size: 16px;
}

/* Ajuste fino para a mensagem de erro */
#authMessage {
    text-align: center;
    font-weight: 600;
}
/* --- FIM NOVO ESTILO PARA TELA DE LOGIN (#authScreen) --- */

</style>
</head>
<body class="light">
  
  <a href="#" id="logoLink">
    <img id="appLogo" src="logo-dark.png" alt="Hells Angels Logo" class="app-logo">
  </a>

  <div id="welcomeScreen"> 
      <img id="welcomeLogo" src="logo-dark.png" alt="Welcome Logo"> 
      <h2 style="font-weight: 900;">Bem-vindo(a)</h2>
      <p style="margin-bottom: 20px; font-size: 16px;">Calculadora e Registro de Vendas Hells Angels</p>
      <button id="enterBtn" class="primary">Entrar no Site</button>
  </div>
  
  <div class="top-right-controls">
      <button class="control-btn" id="tutorialBtn">üí° Tutorial</button> 
      <button class="control-btn" id="themeBtn">üåô Modo Noturno</button>
  </div>

  <div id="authScreen" class="card" style="max-width: 400px; margin: 100px auto 20px auto; display: none;">
      <img src="logo-dark.png" alt="Hells Angels Logo" style="display: block; max-height: 100px; margin: 0 auto 20px auto;">
      
      <h2 id="authTitle">Autentica√ß√£o de Usu√°rio</h2>
      
      <label for="username">Nome de Usu√°rio:</label>
      <input id="username" type="text" placeholder="Seu nome de usu√°rio" autocomplete="username">
      
      <label for="password">Senha:</label>
      <input id="password" type="password" placeholder="Sua senha" autocomplete="current-password">
      
      <div class="actions">
          <button id="authActionBtn" class="primary">Entrar</button>
          <button id="authToggleBtn" class="muted">Cadastrar</button>
      </div>
      <p id="authMessage" style="color: var(--cor-erro); margin-top: 10px;"></p>
  </div>

  <div class="card" id="mainCard" style="display:none">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <h1>Calculadora e Registro de Vendas Hells Angels</h1>
        <button id="logoutBtn" class="danger" style="animation: none;">Sair</button>
    </div>
    
    <div class="card-venda">
        <h2>Dados da Venda</h2>
        <div class="grid grid-venda">
            <div>
                <label for="nomeCliente">Nome:</label>
                <input id="nomeCliente" type="text" value="">
            </div>
            <div>
                <label for="dataVenda">Data:</label>
                <input id="dataVenda" type="text" readonly> 
            </div>
            
            <div>
                <label for="organizacao">Organiza√ß√£o:</label>
                <input id="organizacao" type="text" value="" list="sugestoesOrganizacao">
                
                <p class="suggestion-tip">Digite para ver sugest√µes de organiza√ß√µes.</p>
                
                <datalist id="sugestoesOrganizacao">
                    <option value="Serpents"></option>
                    <option value="Nox"></option>
                    <option value="NKT"></option>
                    <option value="Ruptura"></option>
                    <option value="Midnight"></option>
                    <option value="Meraki"></option>
                    <option value="Lotus"></option>
                    <option value="Hydra"></option>
                    <option value="Hooligans"></option>
                    <option value="Families"></option>
                    <option value="Cartel"></option>
                    <option value="Blood Street"></option>
                    <option value="Blood Reapers"></option>
                    <option value="Blue Diamond"></option>
                    <option value="Black Heart"></option>
                    <option value="Ballas"></option>
                    <option value="Aura"></option>
                    <option value="Anarquia"></option>
                    <option value="8 Anjo"></option>
                    <option value="Vagos"></option>
                    <option value="Vertice"></option>
                    <option value="Void"></option>
                    <option value="Solo"></option>
                </datalist>
            </div>
            <div>
                <label for="organizacaoTipo">Op√ß√£o (CNPJ/CPF):</label>
                <select id="organizacaoTipo">
                    <option value="CNPJ">CNPJ</option>
                    <option value="CPF">CPF</option>
                    <option value="OUTROS">Outros</option>
                </select>
            </div>
            
            <div>
                <label for="telefone">Telefone:</label>
                <input id="telefone" type="text" value="" maxlength="13"> 
            </div>
            
            <div>
                <label for="negociadoras">Negociadoras:</label>
                <input id="negociadoras" type="text" value="">
            </div>
            <div style="grid-column: 1 / -1;">
                <label for="vendaValorObs">Valor - Observa√ß√£o (Como foi o pagamento):</label>
                <input id="vendaValorObs" type="text" value="">
            </div>
        </div>
    </div>
    
    <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--cor-borda);">

    <h2>C√°lculo de Produtos</h2>
    <p class="small">Informe quantos produtos deseja fabricar/vender e escolha o tipo de valor.</p>

    <div class="grid">
      <div>
        <label for="qtyTickets">Quantidade de Tickets</label>
        <input id="qtyTickets" type="number" min="0" value="">
      </div>
      <div>
        <label for="qtyTablets">Quantidade de Tablets</label>
        <input id="qtyTablets" type="number" min="0" value="">
      </div>
      <div>
        <label for="qtyNitro">Quantidade de Nitro</label>
        <input id="qtyNitro" type="number" min="0" value="">
      </div>
      <div>
        <label for="tipoValor">Tipo de Valor</label>
        <select id="tipoValor">
          <option value="limpo">Dinheiro Limpo</option>
          <option value="sujo">Dinheiro Sujo</option>
          <option value="limpo_alianca">Limpo (Alian√ßa)</option>
          <option value="sujo_alianca">Sujo (Alian√ßa)</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <button id="calcBtn" class="primary">Calcular</button>
      <button id="resetBtn" class="muted">Limpar Campos</button>
      <button id="registerBtn" class="success">Registrar Venda</button>
      <button id="cancelEditBtn" class="danger" style="display: none;">Cancelar Edi√ß√£o</button>
      <button id="toggleHistoryBtn" class="muted">Ver Hist√≥rico</button>
      <button id="csvBtn" class="muted">Exportar CSV</button>
      <button id="discordBtnCalc" class="muted">Discord</button> 
    </div>

    <div id="resultsContainer">
      <div id="results" style="margin-top:16px;display:none">
        <h3>Totais necess√°rios</h3>
        <table>
          <thead><tr><th>Material</th><th>Quantidade total</th></tr></thead>
          <tbody id="resultsBody"></tbody>
        </table>

        <h3>Valores Estimados</h3>
        <table>
          <thead><tr><th>Produto</th><th>Valor Total</th></tr></thead>
          <tbody id="valuesBody"></tbody>
          <tfoot>
            <tr><th>Total Geral</th><th id="valorTotalGeral">R$ 0</th></tr>
          </tfoot>
        </table>
        <p class="result-note" style="font-size: 12px; margin-top: 8px;">Os valores variam conforme o tipo selecionado (limpo, sujo, alian√ßa).</p>
      </div>
    </div>
  </div>

  <div class="card" id="historyCard" style="display:none">
      <div id="historyBackground" class="card">
        <h2>Hist√≥rico de Vendas Registradas</h2>
        <img id="historyImg" src="logo-dark.png" alt="Fundo Hist√≥rico"> 
        
        <input type="text" id="filtroHistorico" placeholder="üîç Pesquisar no hist√≥rico (Nome, Data, Item, etc.)" style="margin-bottom: 10px; width: 100%;">
        <div class="actions">
            <button id="clearHistoryBtn" class="muted">Limpar Hist√≥rico</button>
            <button id="toggleCalcBtn" class="muted">Voltar √† Calculadora</button>
        </div>
        <div class="history-table-wrapper"><table id="historicoVendas">
            <thead>
                <tr>
                    <th>Data/Hora</th>
                    <th>Cliente</th>
                    <th>Organiza√ß√£o/Tipo</th>
                    <th>Telefone</th>
                    <th>Produtos (Unidade)</th>
                    <th>Valor Total</th>
                    <th>Negociadoras</th>
                    <th>Registrado Por</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="salesHistory"></tbody>
        </table></div>
      </div>
  </div>
  
  <div id="toast-container"></div>

<script type="module">
    // ------------------------------------
    // 1. IMPORTA√á√ïES E CONFIGURA√á√ÉO FIREBASE
    // ------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAhDVBfXoO_Rdi3e-trdbaaPppwDkTDgVc",
        authDomain: "hells-angels-438c2.firebaseapp.com",
        databaseURL: "https://hells-angels-438c2-default-rtdb.firebaseio.com/",
        projectId: "hells-angels-438c2",
        storageBucket: "hells-angels-438c2.firebasestorage.app",
        messagingSenderId: "429406215315",
        appId: "1:429406215315:web:96b68b172247824b308166",
        measurementId: "G-CR415MEY32"
    };

    // --- [CRITICAL SECURITY NOTE] ---
    // Your Firebase configuration is visible on the client-side. This is normal,
    // but it means you MUST secure your Realtime Database. Without security rules,
    // anyone can read, write, or delete your entire database.
    //
    // Go to your Firebase Console -> Realtime Database -> Rules and paste the
    // following rules to ensure only logged-in users can access the data:
    //
    // {
    //   "rules": {
    //     "vendas": {
    //       ".read": "auth != null",
    //       ".write": "auth != null",
    //       "$vendaId": {
    //         ".validate": "newData.hasChildren(['nomeCliente', 'dataVenda', 'produtos', 'valorTotal', 'registradoPor'])"
    //       }
    //     }
    //   }
    // }
    //
    // This is a basic rule set. You can make it more complex if needed.
    // DO NOT SKIP THIS STEP!
    // ---------------------------------

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ------------------------------------
    // 2. CONSTANTES E ESTADO GLOBAL
    // ------------------------------------
    let vendas = [];
    let vendaEmEdicaoId = null;
    let currentUser = null;

    const PER_UNIT = {
        tickets: { moneyBruto: 525 },
        tablets: { cobre: 20, plastico: 40, fita_adesiva: 2, lixo_eletronico: 2 },
        nitro: { aluminio: 20, cobre: 20, vidro: 45, fita_adesiva: 1, porca: 1, parafuso: 1 }
    };

    const VALORES = {
        tablets: { limpo: 17000, sujo: 20000, limpo_alianca: 15000, sujo_alianca: 18000 },
        tickets: { limpo: 9800, sujo: 11700, limpo_alianca: 8000, sujo_alianca: 10000 },
        nitro: { limpo: 42500, sujo: 50000, limpo_alianca: 38000, sujo_alianca: 45000 }
    };

    const VALOR_DESCRICAO = {
        'limpo': 'Dinheiro Limpo',
        'sujo': 'Dinheiro Sujo',
        'limpo_alianca': 'Limpo (Alian√ßa)',
        'sujo_alianca': 'Sujo (Alian√ßa)'
    };
    
    // Usando 'logo-dark.png' como placeholder
    const LOGO_SRC = "logo-dark.png";

    // Mapeamento de elementos DOM
    const els = {
        body: document.body,
        qtyTickets: document.getElementById('qtyTickets'),
        qtyTablets: document.getElementById('qtyTablets'),
        qtyNitro: document.getElementById('qtyNitro'),
        tipoValor: document.getElementById('tipoValor'),
        nomeCliente: document.getElementById('nomeCliente'),
        organizacao: document.getElementById('organizacao'),
        organizacaoTipo: document.getElementById('organizacaoTipo'),
        telefone: document.getElementById('telefone'),
        negociadoras: document.getElementById('negociadoras'),
        vendaValorObs: document.getElementById('vendaValorObs'),
        dataVenda: document.getElementById('dataVenda'),
        filtroHistorico: document.getElementById('filtroHistorico'),
        resultsBody: document.getElementById('resultsBody'),
        valuesBody: document.getElementById('valuesBody'),
        valorTotalGeral: document.getElementById('valorTotalGeral'),
        results: document.getElementById('results'),
        mainCard: document.getElementById('mainCard'),
        historyCard: document.getElementById('historyCard'),
        salesHistory: document.getElementById('salesHistory'),
        calcBtn: document.getElementById('calcBtn'),
        resetBtn: document.getElementById('resetBtn'),
        registerBtn: document.getElementById('registerBtn'),
        cancelEditBtn: document.getElementById('cancelEditBtn'),
        toggleHistoryBtn: document.getElementById('toggleHistoryBtn'),
        toggleCalcBtn: document.getElementById('toggleCalcBtn'),
        clearHistoryBtn: document.getElementById('clearHistoryBtn'),
        csvBtn: document.getElementById('csvBtn'),
        discordBtnCalc: document.getElementById('discordBtnCalc'),
        themeBtn: document.getElementById('themeBtn'),
        tutorialBtn: document.getElementById('tutorialBtn'),
        logoLink: document.getElementById('logoLink'),
        appLogo: document.getElementById('appLogo'),
        historyImg: document.getElementById('historyImg'),
        welcomeScreen: document.getElementById('welcomeScreen'),
        enterBtn: document.getElementById('enterBtn'),
        welcomeLogo: document.getElementById('welcomeLogo'),
        authScreen: document.getElementById('authScreen'),
        authTitle: document.getElementById('authTitle'),
        username: document.getElementById('username'),
        password: document.getElementById('password'),
        authActionBtn: document.getElementById('authActionBtn'),
        authToggleBtn: document.getElementById('authToggleBtn'),
        authMessage: document.getElementById('authMessage'),
        logoutBtn: document.getElementById('logoutBtn')
    };

    // ------------------------------------
    // 3. FUN√á√ïES DE UTILIDADE E FORMATO
    // ------------------------------------

    const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 0, maximumFractionDigits: 0 });
    const capitalizeText = (text) => text ? text.trim().toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ') : '';
    const getQty = (element) => Math.max(0, parseInt(element.value, 10) || 0);

    const showToast = (message, type = 'default', duration = 3000) => {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, duration);
    };

    const phoneMask = (value) => {
        const PREFIX = "(055) ";
        let digits = value.replace(/\D/g, "");
        if (digits.startsWith("055")) digits = digits.substring(3);
        digits = digits.substring(0, 6);
        let formatted = digits.length > 3 ? `${digits.substring(0, 3)}-${digits.substring(3)}` : digits;
        return PREFIX + formatted;
    };

    const updateDataVenda = () => {
        els.dataVenda.value = new Date().toLocaleDateString('pt-BR');
    };

    // ------------------------------------
    // 4. L√ìGICA DE C√ÅLCULO
    // ------------------------------------
    const calculate = () => {
        const qtyTickets = getQty(els.qtyTickets);
        const qtyTablets = getQty(els.qtyTablets);
        const qtyNitro = getQty(els.qtyNitro);
        const tipoValor = els.tipoValor.value;
        
        if (qtyTickets === 0 && qtyTablets === 0 && qtyNitro === 0) {
            els.results.style.display = 'none';
            return;
        }

        const totals = {
            cobre: qtyTablets * PER_UNIT.tablets.cobre + qtyNitro * PER_UNIT.nitro.cobre,
            plastico: qtyTablets * PER_UNIT.tablets.plastico,
            fita_adesiva: qtyTablets * PER_UNIT.tablets.fita_adesiva + qtyNitro * PER_UNIT.nitro.fita_adesiva,
            lixo_eletronico: qtyTablets * PER_UNIT.tablets.lixo_eletronico,
            aluminio: qtyNitro * PER_UNIT.nitro.aluminio,
            vidro: qtyNitro * PER_UNIT.nitro.vidro,
            porca: qtyNitro * PER_UNIT.nitro.porca,
            parafuso: qtyNitro * PER_UNIT.nitro.parafuso,
            moneyBruto: qtyTickets * PER_UNIT.tickets.moneyBruto
        };

        const values = {
            tickets: qtyTickets * VALORES.tickets[tipoValor],
            tablets: qtyTablets * VALORES.tablets[tipoValor],
            nitro: qtyNitro * VALORES.nitro[tipoValor]
        };
        const totalGeral = values.tickets + values.tablets + values.nitro;

        els.resultsBody.innerHTML = Object.entries(totals)
            .filter(([, amount]) => amount > 0)
            .map(([material, amount]) => `<tr><td>${capitalizeText(material.replace('_', ' '))}</td><td>${amount.toLocaleString('pt-BR')}</td></tr>`)
            .join('');
        
        els.valuesBody.innerHTML = Object.entries(values)
            .filter(([, value]) => value > 0)
            .map(([product, value]) => `<tr><td>${capitalizeText(product)} (${VALOR_DESCRICAO[tipoValor]})</td><td>${formatCurrency(value)}</td></tr>`)
            .join('');
        
        els.valorTotalGeral.textContent = formatCurrency(totalGeral);
        els.results.style.display = 'block';
    };

    // ------------------------------------
    // 5. FUN√á√ïES DE PERSIST√äNCIA (FIREBASE)
    // ------------------------------------
    const getVendaData = () => {
        const qtyTickets = getQty(els.qtyTickets);
        const qtyTablets = getQty(els.qtyTablets);
        const qtyNitro = getQty(els.qtyNitro);

        if (qtyTickets + qtyTablets + qtyNitro === 0) {
            showToast("Nenhum produto selecionado para registro.", "error");
            return null;
        }

        const essentialFields = [els.nomeCliente, els.organizacao];
        let isValid = true;
        essentialFields.forEach(field => {
            field.classList.remove('input-invalido');
            if (!field.value.trim()) {
                field.classList.add('input-invalido');
                isValid = false;
            }
        });

        if (!isValid) {
            showToast("Preencha o Nome e a Organiza√ß√£o antes de registrar.", "error");
            return null;
        }

        calculate();
        const valorTotalNumeric = parseFloat(els.valorTotalGeral.textContent.replace(/[^0-9,-]+/g, "").replace(',', '.'));
        
        const produtos = [];
        if (qtyTickets > 0) produtos.push(`Tickets (${qtyTickets})`);
        if (qtyTablets > 0) produtos.push(`Tablets (${qtyTablets})`);
        if (qtyNitro > 0) produtos.push(`Nitro (${qtyNitro})`);
        
        return {
            nomeCliente: capitalizeText(els.nomeCliente.value) || "N√£o Informado",
            organizacao: capitalizeText(els.organizacao.value),
            organizacaoTipo: els.organizacaoTipo.value,
            telefone: els.telefone.value,
            negociadoras: capitalizeText(els.negociadoras.value) || (currentUser?.displayName || "N√£o Informado"),
            vendaValorObs: capitalizeText(els.vendaValorObs.value) || "S/ Obs",
            dataVenda: new Date().toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' }),
            produtos: produtos.join(', '),
            valorTotal: valorTotalNumeric,
            tipoValor: VALOR_DESCRICAO[els.tipoValor.value],
            registradoPor: currentUser?.displayName || "Desconhecido"
        };
    };

    const registerVenda = async () => {
        const data = getVendaData();
        if (!data) return;

        setLoading(true, els.registerBtn);
        try {
            if (vendaEmEdicaoId) {
                await set(ref(db, 'vendas/' + vendaEmEdicaoId), data);
                showToast("Venda atualizada com sucesso!", "success");
            } else {
                await push(ref(db, 'vendas'), data);
                showToast("Venda registrada com sucesso!", "success");
            }
            clearAllFields();
        } catch (error) {
            console.error("Erro ao registrar/atualizar venda:", error);
            showToast(`Erro ao salvar: ${error.message}`, "error");
        } finally {
            setLoading(false, els.registerBtn);
        }
    };

    const loadHistory = () => {
        onValue(ref(db, 'vendas'), (snapshot) => {
            vendas = [];
            if (snapshot.exists()) {
                snapshot.forEach((child) => vendas.push({ id: child.key, ...child.val() }));
            }
            vendas.reverse();
            filterHistory();
        }, (error) => {
            console.error("Erro ao carregar hist√≥rico:", error);
            showToast(`Erro ao carregar hist√≥rico: ${error.message}`, "error");
        });
    };
    
    const deleteVenda = async (id) => {
        if (!confirm('Tem certeza que deseja excluir esta venda?')) return;
        
        try {
            await remove(ref(db, 'vendas/' + id));
            showToast("Venda exclu√≠da com sucesso!", "default");
            if (vendaEmEdicaoId === id) clearAllFields();
        } catch (error) {
            console.error("Erro ao excluir venda:", error);
            showToast(`Erro ao excluir: ${error.message}`, "error");
        }
    };
    
    const clearHistory = async () => {
        if (!confirm('Tem certeza que deseja APAGAR TODO o hist√≥rico de vendas? Esta a√ß√£o √© irrevers√≠vel.')) return;

        try {
            await remove(ref(db, 'vendas'));
            showToast("Todo o hist√≥rico de vendas foi apagado.", "success");
        } catch (error) {
            console.error("Erro ao limpar hist√≥rico:", error);
            showToast(`Erro ao limpar hist√≥rico: ${error.message}`, "error");
        }
    };

    // ------------------------------------
    // 6. AUTENTICA√á√ÉO
    // ------------------------------------
    const handleAuthAction = async () => {
        const username = els.username.value.trim();
        const password = els.password.value.trim();
        const isRegisterMode = els.authActionBtn.textContent.includes('Cadastrar');

        if (!username || !password) {
            els.authMessage.textContent = 'Preencha o nome de usu√°rio e a senha.';
            return;
        }
        if (isRegisterMode && password.length < 6) {
            els.authMessage.textContent = 'A senha deve ter no m√≠nimo 6 caracteres.';
            return;
        }

        const email = `${username}@hells.com`;
        setLoading(true, els.authActionBtn, els.authToggleBtn);
        els.authMessage.textContent = '';

        try {
            if (isRegisterMode) {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: username });
                showToast(`Usu√°rio ${username} registrado! Fa√ßa o login.`, "success");
                toggleAuthMode(false); // Switch back to login mode
            } else {
                await signInWithEmailAndPassword(auth, email, password);
                // Success is handled by onAuthStateChanged
            }
        } catch (error) {
            const errorMessages = {
                'auth/invalid-credential': "Nome de usu√°rio ou senha incorretos.",
                'auth/user-not-found': "Usu√°rio n√£o encontrado.",
                'auth/wrong-password': "Senha incorreta.",
                'auth/email-already-in-use': "Este nome de usu√°rio j√° est√° em uso.",
                'auth/weak-password': "A senha deve ter pelo menos 6 caracteres."
            };
            els.authMessage.textContent = errorMessages[error.code] || "Ocorreu um erro. Tente novamente.";
            console.error("Auth Error:", error);
        } finally {
            setLoading(false, els.authActionBtn, els.authToggleBtn);
        }
    };

    const handleLogout = async () => {
        try {
            await signOut(auth);
            showToast("Voc√™ saiu com sucesso.", "default");
            vendas = []; // Clear local data on logout
            filterHistory();
        } catch (error) {
            console.error("Logout Error:", error);
            showToast(`Erro ao sair: ${error.message}`, "error");
        }
    };
    
    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        if (user) {
            if (!user.displayName) {
                const usernameFromEmail = user.email.split('@')[0];
                updateProfile(user, { displayName: usernameFromEmail });
                currentUser.displayName = usernameFromEmail;
            }
            loadHistory();
            els.authScreen.style.display = 'none';
            els.mainCard.style.display = 'block';
            els.historyCard.style.display = 'none';
        } else {
            els.authScreen.style.display = 'block';
            els.mainCard.style.display = 'none';
            els.historyCard.style.display = 'none';
        }
        clearTour();
    });

    const toggleAuthMode = (isRegister) => {
        if (isRegister) {
            els.authTitle.textContent = 'Cadastro de Usu√°rio';
            els.authActionBtn.textContent = 'Confirmar Cadastro';
            els.authToggleBtn.textContent = 'Voltar para Login';
            els.authMessage.textContent = 'Preencha os campos para se cadastrar.';
        } else {
            els.authTitle.textContent = 'Autentica√ß√£o de Usu√°rio';
            els.authActionBtn.textContent = 'Entrar';
            els.authToggleBtn.textContent = 'Cadastrar';
            els.authMessage.textContent = '';
        }
    };
    
    // ------------------------------------
    // 7. FUN√á√ïES DE UI E MANIPULA√á√ÉO DO DOM
    // ------------------------------------
    const setLoading = (isLoading, ...buttons) => {
        buttons.forEach(btn => {
            if (btn) btn.disabled = isLoading;
        });
    };

    const clearAllFields = () => {
        const fieldsToClear = [els.qtyTickets, els.qtyTablets, els.qtyNitro, els.nomeCliente, els.organizacao, els.telefone, els.negociadoras, els.vendaValorObs];
        fieldsToClear.forEach(field => field.value = '');
        
        const fieldsToRemoveError = [els.nomeCliente, els.organizacao];
        fieldsToRemoveError.forEach(field => field.classList.remove('input-invalido'));

        els.tipoValor.value = 'limpo';
        els.results.style.display = 'none';
        els.valorTotalGeral.textContent = 'R$ 0';
        
        // Reset edit mode
        vendaEmEdicaoId = null;
        els.registerBtn.textContent = 'Registrar Venda';
        els.cancelEditBtn.style.display = 'none';
        els.resetBtn.style.display = 'inline-flex';
        
        updateDataVenda();
    };
    
    const toggleView = (showHistory) => {
        els.mainCard.style.display = showHistory ? 'none' : 'block';
        els.historyCard.style.display = showHistory ? 'block' : 'none';
        els.appLogo.src = LOGO_SRC;
        if (showHistory) {
            els.filtroHistorico.value = '';
            filterHistory();
        }
    };

    const exportCSV = () => {
        if (vendas.length === 0) return showToast("N√£o h√° vendas para exportar.", "error");

        const headers = ["ID", "Data/Hora", "Registrado Por", "Cliente", "Organiza√ß√£o", "Tipo", "Telefone", "Negociadoras", "Produtos", "Valor Total (R$)", "Tipo Valor", "Observa√ß√£o"];
        const rows = vendas.map(v => [
            v.id, v.dataVenda, v.registradoPor, v.nomeCliente, v.organizacao, v.organizacaoTipo, v.telefone, v.negociadoras,
            `"${v.produtos.replace(/"/g, '""')}"`, v.valorTotal, v.tipoValor, `"${v.vendaValorObs.replace(/"/g, '""')}"`
        ].join(','));

        const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows].join('\n');
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        link.setAttribute("download", `historico_hells_angels_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.csv`);
        link.click();
        link.remove();
        showToast("Hist√≥rico exportado para CSV!", "success");
    };
    
    const exportDiscord = () => {
        const data = getVendaData();
        if (!data) return;

        const produtosLista = data.produtos.split(', ').map(p => `‚Ä¢ ${p}`).join('\n');
        const discordMessage = `
**[ VENDA REGISTRADA ]**
**Registrado Por:** ${data.registradoPor}
**Data:** ${data.dataVenda}

**--- DADOS DO CLIENTE ---**
**Nome:** ${data.nomeCliente}
**Organiza√ß√£o/Op√ß√£o:** ${data.organizacao} (${data.organizacaoTipo})
**Telefone:** ${data.telefone}

**--- PRODUTOS & VALOR ---**
**Produtos:**
${produtosLista}
**Tipo de Valor:** ${data.tipoValor}
**Valor Total:** ${formatCurrency(data.valorTotal)}

**--- INFORMA√á√ïES ADICIONAIS ---**
**Negociadoras:** ${data.negociadoras}
**Pagamento/Observa√ß√£o:** ${data.vendaValorObs}
        `.trim();
        
        navigator.clipboard.writeText(discordMessage)
            .then(() => showToast("Mensagem Discord copiada!", "success"))
            .catch(err => {
                console.error('Erro ao copiar:', err);
                showToast("Erro ao copiar.", "error");
            });
    };
    
    const createHistoryRowHTML = (venda) => {
        const [data, hora = ''] = venda.dataVenda.split(', ');
        const valorObsText = venda.vendaValorObs.length > 15 ? venda.vendaValorObs.substring(0, 12) + '...' : venda.vendaValorObs;

        return `
            <tr id="venda-${venda.id}">
                <td><span class="history-datetime-line">${data}</span><span class="history-datetime-line">${hora}</span></td>
                <td>${venda.nomeCliente}</td>
                <td>${venda.organizacao} (${venda.organizacaoTipo})</td>
                <td>${venda.telefone}</td>
                <td title="${venda.produtos}">${venda.produtos}</td>
                <td class="valor-total-cell" title="${venda.vendaValorObs}">
                    <span>${formatCurrency(venda.valorTotal)}</span>
                    <span class="valor-obs-text">(${valorObsText})</span>
                </td>
                <td>${venda.negociadoras}</td>
                <td>${venda.registradoPor}</td>
                <td class="history-actions-cell">
                    <button data-action="edit" data-id="${venda.id}" class="muted action-btn">Editar</button>
                    <button data-action="delete" data-id="${venda.id}" class="danger action-btn">Excluir</button>
                </td>
            </tr>`;
    };
    
    const filterHistory = () => {
        const filterText = els.filtroHistorico.value.toLowerCase();
        const filteredVendas = vendas.filter(v => 
            `${v.nomeCliente} ${v.organizacao} ${v.produtos} ${v.dataVenda} ${v.negociadoras} ${v.vendaValorObs}`.toLowerCase().includes(filterText)
        );
        
        if (filteredVendas.length > 0) {
            els.salesHistory.innerHTML = filteredVendas.map(createHistoryRowHTML).join('');
        } else {
            const message = vendas.length === 0 
                ? "Nenhuma venda registrada ainda." 
                : `Nenhum resultado encontrado para "${els.filtroHistorico.value}".`;
            els.salesHistory.innerHTML = `<tr><td colspan="9" style="text-align:center; padding: 20px;">${message}</td></tr>`;
        }
    };
    
    const editVenda = (id) => {
        const venda = vendas.find(v => v.id === id);
        if (!venda) return;
        
        toggleView(false);
        
        els.nomeCliente.value = venda.nomeCliente;
        els.organizacao.value = venda.organizacao;
        els.organizacaoTipo.value = venda.organizacaoTipo;
        els.telefone.value = venda.telefone;
        els.negociadoras.value = venda.negociadoras;
        els.vendaValorObs.value = venda.vendaValorObs;

        const ticketsMatch = venda.produtos.match(/Tickets \((\d+)\)/);
        const tabletsMatch = venda.produtos.match(/Tablets \((\d+)\)/);
        const nitroMatch = venda.produtos.match(/Nitro \((\d+)\)/);
        
        els.qtyTickets.value = ticketsMatch ? ticketsMatch[1] : '';
        els.qtyTablets.value = tabletsMatch ? tabletsMatch[1] : '';
        els.qtyNitro.value = nitroMatch ? nitroMatch[1] : '';
        
        const tipoKey = Object.keys(VALOR_DESCRICAO).find(key => VALOR_DESCRICAO[key] === venda.tipoValor);
        els.tipoValor.value = tipoKey || 'limpo';
        
        vendaEmEdicaoId = id;
        els.registerBtn.textContent = 'Salvar Edi√ß√£o';
        els.cancelEditBtn.style.display = 'inline-flex';
        els.resetBtn.style.display = 'none';
        
        calculate();
        showToast(`Editando venda de ${venda.nomeCliente}.`, "default");
        window.scrollTo(0, 0);
    };

    // ------------------------------------
    // 8. L√ìGICA DO TUTORIAL
    // ------------------------------------
    let currentTourStep = 0;
    const tourSteps = [
        { element: els.nomeCliente, title: "1/7: Dados do Cliente", content: "Comece preenchendo o nome do cliente. Lembre-se, a capitaliza√ß√£o √© autom√°tica!" },
        { element: els.organizacao, title: "2/7: Organiza√ß√£o e Telefone", content: "Informe a organiza√ß√£o e o telefone. A m√°scara (055) XXX-XXX √© aplicada automaticamente." },
        { element: els.qtyTickets, title: "3/7: Quantidade de Produtos", content: "Preencha a quantidade de Tickets, Tablets ou Nitro." },
        { element: els.tipoValor, title: "4/7: Tipo de Valor", content: "Escolha o tipo de dinheiro e se a venda √© para uma Alian√ßa." },
        { element: els.calcBtn, title: "5/7: Calcular e Registrar", content: "Use 'Calcular' para ver os totais. Depois, use 'Registrar Venda' para salvar." },
        { element: els.toggleHistoryBtn, title: "6/7: Hist√≥rico de Vendas", content: "Acesse todas as vendas salvas. Voc√™ pode editar, excluir ou exportar." },
        { element: els.discordBtnCalc, title: "7/7: Exportar para o Discord", content: "Use este bot√£o para copiar os dados formatados para colar no Discord!" }
    ];

    const showTourStep = (step) => {
        clearTour();
        const { element, title, content } = tourSteps[step];
        element.classList.add('tour-highlight');

        const tooltip = document.createElement('div');
        tooltip.className = 'tour-tooltip';
        tooltip.id = 'tourTooltip';
        tooltip.innerHTML = `<h4>${title}</h4><p>${content}</p>
            <button id="tourNextBtn">${step < tourSteps.length - 1 ? 'Pr√≥ximo' : 'Finalizar'}</button>
            <button id="tourExitBtn" style="background:#555; color: white;">Sair</button>`;
        els.body.appendChild(tooltip);

        const rect = element.getBoundingClientRect();
        let top = rect.bottom + window.scrollY + 10;
        let left = rect.left + window.scrollX;
        if (left + 300 > window.innerWidth) left = window.innerWidth - 310;
        if (left < 10) left = 10;
        if (rect.bottom > window.innerHeight * 0.7) top = rect.top + window.scrollY - tooltip.offsetHeight - 10;
        
        tooltip.style.top = `${top}px`;
        tooltip.style.left = `${left}px`;
        setTimeout(() => tooltip.classList.add('active'), 10);

        document.getElementById('tourNextBtn').addEventListener('click', nextTourStep);
        document.getElementById('tourExitBtn').addEventListener('click', clearTour);
    };

    const startTour = () => {
        currentTourStep = 0;
        toggleView(false);
        showTourStep(currentTourStep);
    };

    const nextTourStep = () => {
        currentTourStep++;
        if (currentTourStep < tourSteps.length) {
            showTourStep(currentTourStep);
        } else {
            clearTour();
            showToast("Tutorial finalizado!", "success");
        }
    };
    
    const clearTour = () => {
        document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
        const tooltip = document.getElementById('tourTooltip');
        if (tooltip) tooltip.remove();
    };

    // ------------------------------------
    // 9. EVENT LISTENERS E INICIALIZA√á√ÉO
    // ------------------------------------
    const bindEventListeners = () => {
        // A√ß√µes da Calculadora
        els.calcBtn.addEventListener('click', calculate);
        els.resetBtn.addEventListener('click', clearAllFields);
        els.registerBtn.addEventListener('click', registerVenda);
        els.cancelEditBtn.addEventListener('click', clearAllFields);
        els.toggleHistoryBtn.addEventListener('click', () => toggleView(true));
        els.discordBtnCalc.addEventListener('click', exportDiscord);
        els.csvBtn.addEventListener('click', exportCSV);

        // A√ß√µes do Hist√≥rico
        els.toggleCalcBtn.addEventListener('click', () => {
            if (vendaEmEdicaoId) {
                clearAllFields();
                showToast("Edi√ß√£o pendente cancelada.", "error");
            }
            toggleView(false);
        });
        els.clearHistoryBtn.addEventListener('click', clearHistory);
        els.filtroHistorico.addEventListener('input', filterHistory);
        els.salesHistory.addEventListener('click', (e) => {
            const button = e.target.closest('button[data-action]');
            if (!button) return;
            const { action, id } = button.dataset;
            if (action === 'edit') editVenda(id);
            if (action === 'delete') deleteVenda(id);
        });

        // Controles Globais
        els.themeBtn.addEventListener('click', toggleTheme);
        els.tutorialBtn.addEventListener('click', startTour);
        els.logoLink.addEventListener('click', (e) => { e.preventDefault(); toggleView(false); });
        els.logoutBtn.addEventListener('click', handleLogout);
        
        // Tela de Boas-Vindas
        els.enterBtn.addEventListener('click', () => {
            els.welcomeScreen.classList.add('hidden');
            localStorage.setItem('hasVisited', 'true');
            els.welcomeScreen.addEventListener('transitionend', () => els.welcomeScreen.style.display = 'none');
        });

        // Autentica√ß√£o
        els.authActionBtn.addEventListener('click', handleAuthAction);
        els.authToggleBtn.addEventListener('click', () => {
            const isCurrentlyRegisterMode = els.authTitle.textContent.includes('Cadastro');
            toggleAuthMode(!isCurrentlyRegisterMode);
        });
        els.password.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') handleAuthAction();
        });

        // Formata√ß√£o de Inputs
        const fieldsToCapitalize = [els.nomeCliente, els.organizacao, els.negociadoras, els.vendaValorObs];
        fieldsToCapitalize.forEach(field => {
            field.addEventListener('input', (e) => e.target.value = capitalizeText(e.target.value));
        });

        els.telefone.addEventListener('input', (e) => e.target.value = phoneMask(e.target.value));
        els.telefone.addEventListener('focus', (e) => {
            if (!e.target.value.trim() || e.target.value.length < 7) {
                e.target.value = "(055) ";
            }
        });
    };

    const toggleTheme = () => {
        const isDark = els.body.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        els.themeBtn.textContent = isDark ? '‚òÄÔ∏è Modo Claro' : 'üåô Modo Noturno';
        showToast(`Modo ${isDark ? 'Noturno' : 'Claro'} ativado.`, "default");
    };

    const initializeApp = () => {
        bindEventListeners();
        updateDataVenda();

        // Carregar tema salvo
        const savedTheme = localStorage.getItem('theme') || 'light';
        els.body.className = savedTheme;
        if (savedTheme === 'dark') {
            els.themeBtn.textContent = '‚òÄÔ∏è Modo Claro';
        }
        
        // L√≥gica de primeira visita
        if (localStorage.getItem('hasVisited')) {
            els.welcomeScreen.style.display = 'none';
        } else {
            els.welcomeScreen.classList.add('show');
            els.authScreen.style.display = 'none';
            els.mainCard.style.display = 'none';
        }
        
        // Todas as logos s√£o as mesmas
        els.appLogo.src = LOGO_SRC;
        els.historyImg.src = LOGO_SRC;
        els.welcomeLogo.src = LOGO_SRC;
    };
    
    // Inicia a aplica√ß√£o
    initializeApp();
</script>

</body>
</html>
